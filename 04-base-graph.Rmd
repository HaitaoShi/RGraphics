# 基本图形 {#base-graph}

作为知识介绍，本章所有数据都来源于基础 R 包，即安装 R 软件后自带的数据集，图库在以 base R 中的数据集介绍完后，以相应真实数据扩展为案列

## 要素 {#elements} 

点线面

点 pch cex 点的类型和大小  col 
线 lty lwd 线的类型和宽度  col 

颜色 col 连续型和离散型
面/多边形 rect 颜色填充

## 图库 {#gallary}

- 散点图
- 气泡图
- 条形图
- 直方图
- 折线图
- 时序图
- 饼图
- 箱线图
- 茎叶图
- 抖动图

在 base R 中实现的图形，附上 ggplot2 的实现，而 ggplot2 的章节图形提供 base R 实现的图形

强调图对应的数据类型

### 散点图

```{r,echo=TRUE}
data(topo, package="MASS")
```

topo Spatial Topographic Data是地形数据 The topo data frame has 52 rows and 3 columns, of topographic heights within a 310 feet square.

x coordinates (units of 50 feet)
y coordinates (units of 50 feet)
z heights (feet)


### 气泡图

topo 是地形数据

### 轮廓图

topo 是地形数据

等高线图

### 折线图

函数曲线，样条曲线，核密度曲线，平行坐标图，时序图



股价走势曲线

EuStockMarkets         Daily Closing Prices of Major European Stock
                       Indices, 1991-1998
其拓展案例

太阳黑子活动数据

sunspot.month          Monthly Sunspot Data, from 1749 to "Present"
sunspot.year           Yearly Sunspot Data, 1700-1988
sunspots               Monthly Sunspot Numbers, 1749-1983

## 配色 {#colors}


R 内置了 `r length(colors(TRUE))` 种不同颜色的名称，下面随机地选取 20 种颜色

```{r,echo=TRUE}
sample(colors(TRUE),20)
```


调制两个色板

```{r color-pal, fig.cap = "桃色至梨色的渐变"}
# Colors from https://github.com/johannesbjork/LaCroixColoR
color_pal <- c("#FF3200", "#E9A17C", "#E9E4A6", "#1BB6AF", "#0076BB", "#172869")
n <- 16
more_colors <- (grDevices::colorRampPalette(color_pal))(n)
scales::show_col(colours = more_colors)
```

```{r fish-hsv-pal, fig.cap="Hue-Saturation-Value (HSV) color model"}
# colors in colortools from http://www.gastonsanchez.com/
fish_pal <- c("#69D2E7", "#6993E7", "#7E69E7", "#BD69E7", 
              "#E769D2", "#E76993", "#E77E69", "#E7BD69", 
              "#D2E769", "#93E769", "#69E77E", "#69E7BD")
more_colors <- (grDevices::colorRampPalette(fish_pal))(n)
scales::show_col(colours = more_colors)
```

## 字体 {#fonts}

pdf 设备使用 sans 字体 ArialMT + SymbolMT 字体显示，默认字体 

```{r font-sans,echo=TRUE,dev.args=list(family = "sans"),out.width = "55%",fig.width=33/7,fig.cap="默认 sans 字体"}
x <- seq(-4, 4, len = 101)
y <- cbind(sin(x), cos(x))
matplot(x, y,
  type = "l", xaxt = "n",
  main = expression(paste(
    plain(sin) * phi, "  and  ",
    plain(cos) * phi
  )),
  ylab = expression("sin" * phi, "cos" * phi), # only 1st is taken
  xlab = expression(paste("Phase Angle ", phi)),
  col.main = "blue"
)
axis(1,
  at = c(-pi, -pi / 2, 0, pi / 2, pi),
  labels = expression(-pi, -pi / 2, 0, pi / 2, pi)
)
```


```{r,eval=FALSE,echo=TRUE}
CM <- Type1Font(
  "CM",
  c(file.path(
    system.file("fonts", "metrics", package = "fontcm"),
    c(
      "fcmr8a.afm", "fcmb8a.afm", "fcmri8a.afm",
      "fcmbi8a.afm", "cmsyase.afm"
    )
  ))
)
pdfFonts(CM = CM)
```

family 指定字体，默认字体 Helvetica

```{r,eval=FALSE,echo=TRUE}
pdf("cm.pdf", family = "CM", width = 4, height = 4)
par(mar = c(4.1, 4.1, 0.5, 0.5)) 
x <- seq(-4, 4, len = 101)
y <- cbind(sin(x), cos(x))
matplot(x, y,
  type = "l", xaxt = "n",
  main = expression(paste(
    plain(sin) * phi, "  and  ",
    plain(cos) * phi
  )),
  ylab = expression("sin" * phi, "cos" * phi), # only 1st is taken
  xlab = expression(paste("Phase Angle ", phi)),
  col.main = "blue"
)
axis(1,
  at = c(-pi, -pi / 2, 0, pi / 2, pi),
  labels = expression(-pi, -pi / 2, 0, pi / 2, pi)
)
dev.off()
```

```{r missing-fonts,fig.cap="字体缺失",eval=FALSE}
knitr::include_graphics(path = "figures/missing-fonts.png")
```


```{r,eval=FALSE,echo=TRUE}
Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")

# embedFonts(file = "cm.pdf", outfile = "cm-embed.pdf") # GS 默认搜索路径不对

embedFonts(
  file = "cm.pdf", outfile = "cm-embed.pdf",
  fontpaths = system.file("fonts", package = "fontcm")  # 指定字体搜索路径
)
```

参考 [@Paul_2006_fonts] fontcm 字体

[cmr-fonts]: https://www.stat.auckland.ac.nz/~paul/R/CM/CMR.html

**knitr** 支持的引擎有：

```{r,echo=TRUE}
names(knitr::knit_engines$get())
```

## Graphviz

先安装 Graphviz^[Graphviz 官网 <http://www.graphviz.org/>]，常用于绘制流程图，广泛用于 tensorflow 和 mxnet 的模型描述中，如图所示

```{r dot-ex, engine = "dot", fig.cap = "Funky dot",eval=FALSE}
digraph test123 {
  a -> b -> c;
  a -> {x y};
  b [shape=box];
  c [label="hello\nworld",color=blue,fontsize=24,
      fontname="Palatino-Italic",fontcolor=red,style=filled];
  a -> z [label="hi", weight=100];
  x -> z [label="multi-line\nlabel"];
  edge [style=dashed,color=red];
  b -> x;
  {rank=same; b x}
}
```

## TikZ {#tikz}

如图所示，模板来自 `system.file('misc', 'tikz2pdf.tex', package = 'knitr')`

```{tikz demo-tikz, fig.cap='tikz 图形', engine.opts = list(template = "code/chapter_03/tikz2pdf.tex"),eval=F}
\begin{tikzpicture}[scale=.7]
\draw [fill=gray!30,very thick] (0,-1) rectangle (5,1);
\draw [very thick] (5, 0) -- (13,0);
\node [below] at (2,-1) {\large Hello};
\node [below, align=center] at (0,-1) {\large Two\\ lines};
\end{tikzpicture}
```

再来一张稍微复杂的图形，如图所示

```{tikz complicated-tikz, fig.cap='稍复杂的 tikz 图形', engine.opts = list(template = "code/chapter_03/tikz2pdf.tex"),eval=F}
\usetikzlibrary{arrows}
\begin{tikzpicture}[node distance=2cm, auto, >=latex, thick, scale = 1.5]
\node (P) {$P$};
\node (B) [right of=P] {$B$};
\node (A) [below of=P] {$A$};
\node (C) [below of=B] {$C$};
\node (P1) [node distance=1.4cm, left of=P, above of=P] {$\hat{P}$};
\draw[->] (P) to node {$f$} (B);
\draw[->] (P) to node [swap] {$g$} (A);
\draw[->] (A) to node [swap] {$f$} (C);
\draw[->] (B) to node {$g$} (C);
\draw[->, bend right] (P1) to node [swap] {$\hat{g}$} (A);
\draw[->, bend left] (P1) to node {$\hat{f}$} (B);
\draw[->, dashed] (P1) to node {$k$} (P);
\end{tikzpicture}
```

**tikzDevice** 包 [@R-tikzDevice] 可以方便的把 R 代码转化为 tikz 代码，然后使用 LaTeX 引擎编译成 PDF 文档，特别地，它很好地支持了图里的数学公式

```{r,eval=FALSE}
library(tikzDevice)
tf <- file.path(getwd(), "demo-tikzDevice.tex")
tikz(tf, width = 6, height = 4, pointsize = 30, standAlone = TRUE)
# 绘图的代码，仅支持 Base R Graphics System
source(file = "code/chapter_03/matern.R")
dev.off()
tools::texi2dvi(tf, pdf = T)
system("rm demo-tikzDevice.tex *.log *.aux *.dvi")
system("convert -density 300 -trim demo-tikzDevice.pdf -quality 100 demo-tikzDevice.png")
system("mv demo-tikzDevice.* figures/")
# convert test.svg test.png
```

如图所示

```{r demo-tikzDevice,fig.cap="tikzDevice绘图",echo=FALSE,eval=FALSE}
knitr::include_graphics(path = "figures/demo-tikzDevice.png")
```

```{r linear-model,dev='tikz',fig.cap="线性回归模型",out.width="35%",fig.asp=1,fig.width=3.5,tikz2png='-quality 100 -density 300',fig.process=to_png,eval=.Platform$OS.type=="unix"}
# 带有图标题
par(mar = c(4.1, 4.1, 4.5, 1.5), ps = 13, family = "Times")
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste("$y = ", round(coef(model)[2], 3),
  "x +", round(coef(model)[1], 3), "$",
  sep = ""
), bty = "n")

plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste("$y = ", round(coef(model)[2], 3),
  "x +", round(coef(model)[1], 3), "$",
  sep = ""
), bty = "n")
```

```{r bessel,dev='tikz',fig.cap="贝塞尔函数",out.width="35%",fig.asp=1,fig.width=2.5,tikz2png='-quality 100 -density 300',fig.process=to_png,eval=.Platform$OS.type=="unix"}
x0 <- 2^(-20:10)
nus <- c(0:5, 10, 20)
x <- seq(0, 4, length.out = 501)

plot(x0, x0^-8,frame.plot=TRUE,
     log = "xy", xlab = "$u$", axes = FALSE,
     ylab = "$\\mathcal{K}_{\\kappa}(u)$", 
     type = "n", ann = TRUE, panel.first = grid()
) # x 和 y 轴都取对数

axis(1,
     at = c(1e-08, 1e-06, 1e-04, 1e-02, 1, 1e+02),
     labels = expression(10^-8, 10^-6, 10^-4, 10^-2, 1, 10^2)
)
axis(2,
     at = c(1e-16, 1, 1e+16, 1e+32, 1e+48),
     labels = expression(10^-16, 1, 10^16, 10^32, 10^48), las = 1
)
# 设置线条颜色
cols <- RColorBrewer::brewer.pal(9,name = "Spectral")
# gray.colors(9) terrain.colors(9)  RColorBrewer::brewer.pal(9,name = "Spectral")
for (i in seq(length(nus)))
  lines(x0, besselK(x0, nu = nus[i]), col = cols[i], lwd = 2)
legend("topright",legend = paste0("$\\kappa=", rev(nus),"$"),
       col = rev(cols), lwd = 2, cex = 0.5)

# 数据变化范围太大，因此横纵坐标轴都取了以10为底的对数，数据可以紧凑的在一张图内展示
x <- seq(0, 40, length.out = 801)
x <- x[x > 0]
plot(x, x,frame.plot=TRUE,
     ylim = c(1e-18, 1e11), log = "y", xlab = "$u$", type = "n",  yaxt = "n",
     ylab = "$\\mathcal{K}_{\\kappa}(u)$", ann = TRUE, panel.first = grid()
)
axis(2,
     at = c(1e-19, 1e-12, 1e-05, 1e+02, 1e+09),
     labels = expression(10^-19, 10^-12, 10^-5, 10^2, 10^9), las = 1
)

for (i in seq(length(nus)))
  lines(x, besselK(x, nu = nus[i]), col = cols[i], lwd = 2)
legend("topright", legend = paste0("$\\kappa=", rev(nus),"$"), 
       col = rev(cols), lwd = 2, cex = 0.5)
```

## Asymptote {#asy}

Asymptote 图形如图所示

```{asy demo-asymptote, fig.cap='Asymptote 图形', echo=FALSE,out.width = "35%",eval=F}
pair crease(pair z1, pair z2, bool left){
  pair dz = z2 - z1;
  if (left)
    return z1 + dz * (0.5, 0.5);
  else
    return z1 + dz * (0.5, -0.5);
}
pair[] fold(pair[] oldz){
  int n = oldz.length;
  pair[] newz = new pair[2n-1];
  for (int i = 0; i < n-1; ++i)
    {
      newz[2i] = oldz[i];
      newz[2i+1] = crease(oldz[i], oldz[i+1], i%2==0);
    }
  newz[2(n-1)] = oldz[n-1];
  return newz;
}
pair[] dragon(int n, pair[] base={}){
  if (base.length == 0)
    if (n%2 == 0)
      base = new pair[] {(0,0), (1,1) };
    else
      base = new pair[] {(0,0), (1,0) };

  pair[] z = base;
  for (int i = 1; i < n; ++i)
    z = fold(z);

  return z;
}
void drawtris(pair[] z, pen p = currentpen){
  int n = z.length;
  for (int i = 0; i < n-2; i+=2)
    fill(z[i]--z[i+1]--z[i+2]--cycle, p);
}
void drawtris(pair[] z, pen p1, pen p2){
  int n = z.length;
  for (int i = 0; i < n-2; i+=2)
    fill(z[i]--z[i+1]--z[i+2]--cycle, 2i < n-1 ? p1 : p2);
}
size(500,0);
int n = 10;
drawtris(dragon(n, new pair[] {(0,0), (1,0)}), black);
drawtris(dragon(n, new pair[] {(0,0), (0,-1)}), blue);
drawtris(dragon(n, new pair[] {(0,0), (-1,0)}), red);
drawtris(dragon(n, new pair[] {(0,0), (0,1)}),  green);
```


## 魔法 {#magick}

旋转坐标轴标签

```{r,eval=FALSE}
# Rotated axis labels in R plots
# https://menugget.blogspot.com/2014/08/rotated-axis-labels-in-r-plots.html
# Example data
tmin <- as.Date("2000-01-01")
tmax <- as.Date("2001-01-01")
tlab <- seq(tmin, tmax, by = "month")
lab <- format(tlab, format = "%Y-%b")
set.seed(111)
x <- seq(tmin, tmax, length.out = 100)
y <- cumsum(rnorm(100))

# Plot
# png("plot_w_rotated_axis_labels.png", height = 3, 
#     width = 6, units = "in", res = 300)
op <- par(mar = c(6, 4, 1, 1))
plot(x, y, t = "l", xaxt = "n", xlab = "")
axis(1, at = tlab, labels = FALSE)
text(
  x = tlab, y = par()$usr[3] - 0.1 * (par()$usr[4] - par()$usr[3]),
  labels = lab, srt = 45, adj = 1, xpd = TRUE
)
par(op)
# dev.off()
```





