# 字体和颜色 {#colors-fonts}

## 配色 {#colors}

调色板合集 [paletteer](https://github.com/EmilHvitfeldt/paletteer)，其收录了很多 R 包制作的调色板

R 内置了 `r length(colors(TRUE))` 种不同颜色的名称，下面随机地选取 20 种颜色

```{r,echo=TRUE}
sample(colors(TRUE),20)
```


调制两个色板

```{r color-pal, fig.cap = "桃色至梨色的渐变"}
# Colors from https://github.com/johannesbjork/LaCroixColoR
color_pal <- c("#FF3200", "#E9A17C", "#E9E4A6", "#1BB6AF", "#0076BB", "#172869")
n <- 16
more_colors <- (grDevices::colorRampPalette(color_pal))(n)
scales::show_col(colours = more_colors)
```

```{r fish-hsv-pal, fig.cap="Hue-Saturation-Value (HSV) color model"}
# colors in colortools from http://www.gastonsanchez.com/
fish_pal <- c("#69D2E7", "#6993E7", "#7E69E7", "#BD69E7", 
              "#E769D2", "#E76993", "#E77E69", "#E7BD69", 
              "#D2E769", "#93E769", "#69E77E", "#69E7BD")
more_colors <- (grDevices::colorRampPalette(fish_pal))(n)
scales::show_col(colours = more_colors)
```

## 字体 {#fonts}

在 Ubuntu 系统上安装微软字体，如果因为网络原因，下载出现问题，也有可能是长期没有维护更新，默认字体下载链接失效了

```bash
sudo apt-get install ttf-mscorefonts-installer
```

因此，需要手动下载字体到目录 `~/msfonts/`下

```{r,eval=FALSE,echo=TRUE}
baseurl <- "https://nchc.dl.sourceforge.net/project/corefonts/the%20fonts/final"
fonts <- c(
  "webdin32", "verdan32", "trebuc32", "times32",
  "impact32", "georgi32", "courie32", "comic32",
  "arialb32", "arial32", "andale32"
)
fonts_exe <- paste0(fonts, ".exe")
fonts_url <- paste(baseurl, fonts_exe, sep = "/")

if (!dir.exists("~/msfonts")) {
  dir.create("~/msfonts")
}

for (i in seq(length(fonts)))
  download.file(
    url = fonts_url[i], 
    destfile = paste("~/msfonts", fonts_exe[i], sep = "/"),
    method = "auto"
  )
```

字体下载完后，手动配置字体

```bash
sudo dpkg-reconfigure ttf-mscorefonts-installer
```

注意要输入字体存放的完整路径 `/home/ubuntu/msfonts` 而不是相对路径 `~/msfonts`，安装完成后，字体存放在系统目录`/usr/share/fonts/truetype/msttcorefonts/`下，接下来可以查看已经安装的字体

```bash
fc-list :lang=zh | sort
fc-list :lang=en | sort
```

此外，安装常见的等宽字体 inconsolata

```bash
sudo apt install fonts-inconsolata
```

以常用的新罗马字体为例，在 R 绘图代码中全局设置字体 `par(family="Times")` 或者 `par(family="serif")`，数据集 ais 的含义，散点图 \@ref(fig:times-font) 表达的统计意义
 
```{r times-font,out.width="45%",fig.width=27/7,fig.asp=1,dev.args=list(family = "serif"),fig.cap="数学字体"}
data(ais, package = 'DAAG')
plot(hg ~ rcc,
  data = ais,
  xlab = expression("Red cell count (" * 10^12 * italic(l)^{
    -1
  } * ")"),
  ylab = expression("Hemaglobin (" * g * dot(" ") * daL^{
    -1
  } * ")")
)
```

pdf 设备使用 sans 字体 ArialMT + SymbolMT 字体显示，默认字体，添加代码块设置 `dev.args=list(family = "sans")` 图\@ref(fig:sans-font)

```{r sans-font,echo=TRUE,out.width = "45%",fig.width=27/7,fig.cap="默认 sans 字体",fig.asp=1}
par(mar=c(4,4,2,1))
x <- seq(-4, 4, len = 101)
y <- cbind(sin(x), cos(x))
matplot(x, y,
  type = "l", xaxt = "n",
  main = expression(paste(
    plain(sin) * phi, "  and  ",
    plain(cos) * phi
  )),
  ylab = expression("sin" * phi, "cos" * phi), # only 1st is taken
  xlab = expression(paste("Phase Angle ", phi)),
  col.main = "blue"
)
axis(1,
  at = c(-pi, -pi / 2, 0, pi / 2, pi),
  labels = expression(-pi, -pi / 2, 0, pi / 2, pi)
)
```


```{r,eval=FALSE,echo=TRUE}
CM <- Type1Font(
  "CM",
  c(file.path(
    system.file("fonts", "metrics", package = "fontcm"),
    c(
      "fcmr8a.afm", "fcmb8a.afm", "fcmri8a.afm",
      "fcmbi8a.afm", "cmsyase.afm"
    )
  ))
)
pdfFonts(CM = CM)
```

family 指定字体，默认字体 Helvetica

```{r,eval=FALSE,echo=TRUE}
pdf("cm.pdf", family = "CM", width = 4, height = 4)
par(mar = c(4.1, 4.1, 0.5, 0.5)) 
x <- seq(-4, 4, len = 101)
y <- cbind(sin(x), cos(x))
matplot(x, y,
  type = "l", xaxt = "n",
  main = expression(paste(
    plain(sin) * phi, "  and  ",
    plain(cos) * phi
  )),
  ylab = expression("sin" * phi, "cos" * phi), # only 1st is taken
  xlab = expression(paste("Phase Angle ", phi)),
  col.main = "blue"
)
axis(1,
  at = c(-pi, -pi / 2, 0, pi / 2, pi),
  labels = expression(-pi, -pi / 2, 0, pi / 2, pi)
)
dev.off()
```

```{r missing-fonts,fig.cap="字体缺失",eval=FALSE}
knitr::include_graphics(path = "figures/missing-fonts.png")
```


```{r,eval=FALSE,echo=TRUE}
Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")
# embedFonts(file = "cm.pdf", outfile = "cm-embed.pdf") # GS 默认搜索路径不对
embedFonts(
  file = "cm.pdf", outfile = "cm-embed.pdf",
  fontpaths = system.file("fonts", package = "fontcm")  # 指定字体搜索路径
)
```

参考 [@Paul_2006_fonts] fontcm 字体

[cmr-fonts]: https://www.stat.auckland.ac.nz/~paul/R/CM/CMR.html

调用系统字体，安装使用网络字体

```{r,eval=FALSE,echo=TRUE}
library(showtext,quietly = TRUE)
showtext_auto()
pdf("google-fonts.pdf")
font_add_google("Alegreya Sans", "aleg")
par(family = "serif")
plot(0:5,0:5, type="n")
text(1:4, 1:4, "Serif", font=1:4, cex = 2)
par(family = "fira-sans")
plot(0:5,0:5, type="n")
text(1:4, 1:4, "Sans", font=1:4, cex = 2)
dev.off()
```


**knitr** 支持的引擎有：

```{r,echo=TRUE}
names(knitr::knit_engines$get())
```

导入系统TTF类型字体到 R 环境中，这样绘图可以使用更多的字体

```{r,echo=TRUE,eval=FALSE}
install.packages('extrafont')
library(extrafont)
font_import()
# 查看可用的字体
# Vector of font family names
fonts()
# Show entire table
fonttable()
# 加载字体

# Only necessary in session where you ran font_import()
loadfonts()
# For PostScript output, use loadfonts(device="postscript")
# Suppress output with loadfonts(quiet=TRUE)
```

测试字体是否被正确调用

```{r,echo=TRUE,eval=FALSE}
pdf("font_Impact.pdf", family="Impact", width=4, height=4)
par(mar = c(4.1, 4.1, 2.1, 0.5)) 
plot(mtcars$mpg, mtcars$wt, 
     main = "Fuel Efficiency of 32 Cars",
     xlab = "Weight (x1000 lb)",
     ylab = "Miles per Gallon")
dev.off()
```

PDF 格式图片转 PNG 格式

```bash
convert -quality 100 -density 300x300 font_Impact.pdf font_Impact.png
```

```{r fonts-Impact,fig.cap="Impact 字体"}
knitr::include_graphics(path = "figures/font_Impact.png")
```


