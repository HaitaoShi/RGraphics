# 绘图素材库 {#graph-gallery}

::: sidebar
作为知识介绍，本章所有数据都来源于基础 R 包，即安装 R 软件后自带的数据集，图库在以 base R 中的数据集介绍完后，以相应真实数据扩展为案列，结合统计意义和探索性数据分析介绍各种常见统计图形
:::

数据可视化是一种重要的数据分析手段，Claus O. Wilke 目前正在写《Fundamentals of Data Visualization》，并且给出了在线网络版 <https://serialmentor.com/dataviz/>。 R 提供了两套图形系统，分别是 graphics 包提供的基础绘图系统和 grid 包提供的栅格绘图系统，后者主要以两个 R 包为大家所熟知，一个是 lattice 包，另一个是 ggplot2 包。

准备好以下绘制统计图形的 R 包

```{r load-pkgs,echo=TRUE}
library(grid)
library(lattice)
library(ggplot2)
```

## 要素 {#elements} 

点线面

点 pch cex 点的类型和大小  col 
线 lty lwd 线的类型和宽度  col 

颜色 col 连续型和离散型
面/多边形 rect 颜色填充

各种符号 \@ref(fig:cex-symbol) 

```{r cex-symbol,fig.cap="cex 支持的符号",echo=TRUE,fig.asp=.9}
plot(0, 0,
  xlim = c(1, 5), ylim = c(-.5, 4),
  axes = F,
  xlab = "", ylab = ""
)
for (i in 0:4) {
  for (j in 1:5) {
    n <- 5 * i + j
    points(j, i,
      pch = n,
      cex = 3
    )
    text(j, i - .25, as.character(n))
  }
}
```

点、线、多边形和圆聚集在图 \@ref(fig:symbols) 中

```{r symbols,fig.cap="多边形和符号元素",echo=TRUE}
# https://jeroen.github.io/uros2018/#23
plot.new()
plot.window(xlim = c(0, 100), ylim = c(0, 100))
polygon(c(10, 40, 80), c(10, 80, 40), col = "hotpink")
text(40, 90, labels = "My drawing", col = "navyblue", cex = 3)
symbols(c(70, 80, 90), c(20, 50, 80),
  circles = c(10, 20, 10),
  bg = c("yellow", "orange", "red"), add = TRUE, lty = "dashed"
)
```

在介绍各种统计图形之前，先介绍几个绘图函数 `plot` 和 `text` 还有 `par` 参数设置， 作为最简单的开始，尽量依次介绍其中的每个参数的含义并附上图形对比。

```{r pos,fig.cap="pos 位置参数",echo=TRUE,fig.asp=.9}
y <- x <- 1:4
plot(x, y, ann = F, col = "blue", pch = 16)
text(x, y,
  labels = c("1st", "2nd", "3rd", "4th"),
  col = "red", pos = c(3, 4, 4, 1), offset = 0.6
)
ahat <- "sigma"
# title(substitute(hat(a) == ahat, list(ahat = ahat)))
title(bquote(hat(a) == .(ahat)))
```

其中 labels， pos 都是向量化的参数

## 图库 {#gallary}



```{r plot,echo=FALSE,fig.width=7,fig.height=9,fig.cap='plot函数对象',fig.asp=1}
# pdf(file = 'plot.pdf',width=10,height=6)
# layout(matrix(seq(6), 2, 3, byrow = TRUE))
# 矩阵图 自带 layout
# plot(iris[,-5],col = iris$Species)
par(mfrow = c(3, 2), mar = c(2.5, 2.5, .5, .5))
# 分类散点图
plot(Sepal.Length ~ Sepal.Width, data = iris, col = Species, pch = 16)
legend("topright",
  legend = unique(iris$Species), box.col = "gray",
  pch = 16, col = unique(iris$Species)
)
box(col = "gray")
# 气泡图
plot(Volume ~ Height,
  data = trees, pch = 16, cex = Girth / 8,
  col = rev(terrain.colors(nrow(trees), alpha = .5))
)
box(col = "gray")
# 折线图
plot(AirPassengers)
box(col = "gray")
# 柱形图
set.seed(123456)
barPois <- table(stats::rpois(1000, lambda = 5))
plot(barPois, col = "lightblue", type = "h", lwd = 10, main = "")
box(col = "gray")
# 马赛克图
# par(mar=c(2,2,.5,.5))
plot(HairEyeColor, col = "lightblue", border = "white", main = "")
# box(col="gray")
## 直方图
set.seed(1234)
n <- 2^24
x <- runif(n, 0, 1)
delta <- 0.01
len <- diff(c(0, which(x < delta), n + 1)) - 1
ylim <- seq(0, 1800, by = 300)
xlim <- seq(0, 100, by = 20)
p <- hist(len[len < 101], breaks = -1:100 + 0.5, plot = FALSE)
plot(p, ann = FALSE, axes = FALSE, col = "lightblue", border = "white", main = "")
axis(1, labels = xlim, at = xlim, las = 1) # x 轴
axis(2, labels = ylim, at = ylim, las = 0) # y 轴
box(col = "gray")
```



### 条形图 {#plot-bar}

```{r ISLR,fig.width=5,fig.height=4,fig.cap='条形图',echo=TRUE}
data(NCI60, package = "ISLR") # 加载数据
myData <- sort(table(NCI60$labs), decreasing = TRUE)
par(mar = c(2, 7, 1, 1))
barCenters <- barplot(myData,
  col = "lightblue", axes = FALSE,
  axisnames = FALSE, horiz = TRUE, border = "white"
)
text(
  y = barCenters, x = par("usr")[3],
  adj = 1, labels = names(myData), xpd = TRUE
)
axis(1,
  labels = seq(0, 9, by = 1), at = seq(0, 9, by = 1),
  las = 1, col = "gray"
)
```


### 直方图 {#plot-hist}

```{r eruptions,fig.cap="老忠实泉间歇性喷水的时间间隔分布",echo=TRUE}
with(data = faithful, {
  hist(eruptions, seq(1.6, 5.2, 0.2), prob = TRUE, main = "")
  lines(density(eruptions, bw = 0.1))
  rug(eruptions) # 添加数据点
})
```

```{r,fig.cap="概率密度分布",echo=TRUE}
hist(longley$Unemployed,
  probability = TRUE,
  col = "light blue", main = ""
)
# 添加密度估计
lines(density(longley$Unemployed),
  col = "red",
  lwd = 3
)
```

直方图有很多花样的，添加阴影线，angle 控制倾斜的角度

```{r,fig.cap="density 数值越大阴影线越密",echo=TRUE}
# hist(longley$Unemployed, density = 1, angle = 45)
# hist(longley$Unemployed, density = 3, angle = 15)
# hist(longley$Unemployed, density = 1, angle = 15)
hist(longley$Unemployed, density = 3, angle = 45, main = "")
```

### 密度图 {#plot-density}


```{r,echo=TRUE}
library(MASS)
data(galaxies)
galaxies <- galaxies/1000
# Bandwidth Selection by Pilot Estimation of Derivatives
c(width.SJ(galaxies, method = "dpi"), width.SJ(galaxies))
plot(x = c(5, 40), y = c(0, 0.2), type = "n", bty = "l",
         xlab = "velocity of galaxy (km/s)", ylab = "density")
rug(galaxies)
lines(density(galaxies, width = 3.25, n = 200),col = 'blue', lty = 1)
lines(density(galaxies, width = 2.56, n = 200),col = 'red', lty = 3)
```

```{r,echo=TRUE,title.mar=TRUE,fig.asp=1,out.width="65%",fig.width=6.5}
x <- seq(from = 110, to = 174, by = 0.5)
y1 <- dnorm(x, mean = 145, sd = 9)
y2 <- dnorm(x, mean = 138, sd = 8)
plot(x, y1, type="l", lwd=2, col="red",
     main="Systolic Blood Pressure Before and After Treatment",
     xlab = "Systolic Blood Pressure (mmHg)",
     ylab = "Frequency", yaxt="n",
     xlim = c(110, 175), ylim = c(0, 0.05))
lines(x, y2)
polygon(c(110,x,175),c(0,y2,0), col="firebrick3",
     border = "white")
polygon(c(117,x,175),c(0,y1,0), col="dodgerblue4",
     border = "white")
ylab = c(seq(from=0, to=175, by=25))
y = c(seq(from=0, to=0.05, length.out = 8))
axis(2,at=y,labels=ylab, las=1)
text(x = 120, y = 0.045, "- Pre-Treatment BP", col = "dodgerblue4", cex = 0.9)
text(x = 120, y = 0.04, " - Post-Treatment BP", col = "firebrick3", cex = 0.9)
points(109, 0.0445, pch = 15, col = "dodgerblue4")
points(109, 0.0395, pch = 15, col = "firebrick3")
```


```{r,echo=TRUE,title.mar=TRUE,fig.asp=1,out.width="45%",fig.width=4.5}
days <- abs(rnorm(1000, 80, 125))
plot(density(days, from = 0),
  main = "Density plot",
  xlab = "Number of days since trial started"
)
plot(density(days, from = 0, to = 180, adjust = 0.2),
  main = "Density plot - Up to 180 days (86% of data)",
  xlab = "Number of days since trial started"
)
```

```{r,echo=TRUE,title.mar=TRUE,fig.asp=1,out.width="75%",fig.width=7.5}
library(survival)
surv.days <- Surv(days)
surv.fit <- survfit(surv.days ~ 1)
plot(surv.fit,
  main = "Kaplan-Meier estimate with 95% confidence bounds (86% of data)",
  xlab = "Days since trial started",
  xlim = c(0, 180),
  ylab = "Survival function"
)
grid(20, 10, lwd = 2)
```

```{r,include=FALSE}
HeatedDensityPlot <- function(x,
                              title = "",
                              x.title = "x",
                              colors = c("#d7191c", "#fdae61", "#ffffbf", "#abdda4", "#2b83ba"),
                              show.legend = TRUE,
                              legend.title = "Cumulative %",
                              n = 512, # Number of unique values of x in the heatmap/density estimation
                              n.breaks = 5, # Number of values of x to show on the x-axis. Final number may differ.
                              ...) {
  # Checking inputs.
  n.obs <- length(x)
  if (any(nas <- is.na(x))) {
    warning(sum(nas), " observations with missing values have been removed.")
    x <- x[!nas]
    n.obs <- length(x)
  }
  if (n.obs < 4) {
    stop(n.obs, " is too few observations for a valid density plot. See Silverman (1986) Density Estimation for Statistics and Data Analysis.")
  }
  # Computing densities
  dens <- density(x, ...)
  y.max <- max(dens$y) * 1.1 # To ensure top of plot isn't too close to title
  x.to.plot.true <- x.to.plot <- dens$x
  y.seq <- c(0, y.max / 2, y.max)
  y.to.plot <- dens$y
  range.x <- range(x)
  cum.dens <- ecdf(x)(x.to.plot) # * 100
  # Due to plotly blug that misaligns heatmap with ensuing white line,
  # putting blanks at beginnig of data.
  n.blanks <- 10
  cum.dens <- c(rep(NA, n.blanks), cum.dens)
  diff <- x.to.plot[1] - x.to.plot[2]
  blanks <- diff * (n.blanks:1) + x.to.plot[1]
  x.to.plot <- c(blanks, x.to.plot)
  y.to.plot <- c(rep(0, n.blanks), y.to.plot)
  # Creating the matrix of heatmap values
  cum.perc <- cum.dens * 100
  z.mat <- matrix(cum.perc,
    byrow = TRUE, nrow = 3, ncol = n + n.blanks,
    dimnames = list(y = y.seq, x = x.to.plot)
  )
  # Specifying the colors
  col.fun <- scales::col_numeric(colors, domain = 0:1, na.color = "white") # range.x)
  x.as.colors <- col.fun(cum.dens)
  z.to.plot.scaled <- scales::rescale(cum.perc)
  color.lookup <- setNames(data.frame(z.to.plot.scaled, x.as.colors), NULL)
  # Creating the base heatmap.
  require(plotly)
  p <- plot_ly(
    z = z.mat,
    xsrc = x.to.plot,
    ysrc = y.seq,
    type = "heatmap",
    colorscale = color.lookup,
    cauto = FALSE,
    hoverinfo = "none",
    colorbar = list(title = legend.title),
    showscale = show.legend
  )
  # Placing white on top of the bits of the heatmap to hide
  p <- add_trace(p,
    x = c(1:(n + n.blanks), (n + n.blanks):1),
    y = c(y.to.plot, rep(y.max * 1.10, n + n.blanks)),
    fill = "tonexty",
    hoverinfo = "none",
    showlegend = FALSE,
    type = "scatter",
    mode = "line",
    showscale = FALSE,
    line = list(color = "white", width = 0),
    fillcolor = "white"
  )
  # Adding the tooltips
  p <- add_trace(p,
    x = 1:(n + n.blanks),
    y = y.to.plot,
    name = "",
    hoverinfo = "text",
    text = sprintf(paste0(x.title, ": %.0f %% < %.1f"), cum.perc, x.to.plot),
    type = "scatter",
    mode = "lines",
    line = list(color = "white", width = 0),
    showlegend = FALSE,
    showscale = FALSE
  )
  p <- plotly::config(p, displayModeBar = FALSE)
  # Formatting the x axis
  x.text <- pretty(x.to.plot, n = n.breaks)
  x.tick <- 1 + (x.text - x.to.plot[1]) / (x.to.plot[n + n.blanks] - x.to.plot[1]) * (n + n.blanks - 1)
  p <- layout(p,
    title = title,
    xaxis = list(title = x.title, tickmode = "array", tickvals = x.tick, ticktext = x.text),
    yaxis = list(title = "", showline = FALSE, ticks = "", showticklabels = FALSE, range = c(0, y.max)),
    margin = list(t = 30, l = 5, b = 50, r = 5)
  )
  p
}
```

```{r,echo=TRUE}
HeatedDensityPlot(days,
  from = 0,
  title = "Heated density plot",
  x.title = "Number of days since trial started",
  legend.title = "% of buyers"
)
```

```{r,echo=TRUE}
HeatedDensityPlot(days,
  from = 0, to = 180, adjust = 0.2,
  title = "Heated density plot - Up to 180 days (86% of data)",
  x.title = "Number of days since trial started",
  legend.title = "% of buyers"
)
```

[visualize-distributions]: https://www.displayr.com/using-heatmap-coloring-density-plot-using-r-visualize-distributions/

### 经验图 {#plot-ecdf}

```{r faithful,echo=TRUE,fig.cap="累积经验分布图"}
with(data = faithful, {
  long <- eruptions[eruptions > 3]
  plot(ecdf(long), do.points = FALSE, verticals = TRUE, main = "")
  x <- seq(3, 5.4, 0.01)
  lines(x, pnorm(x, mean = mean(long), sd = sqrt(var(long))), lty = 3)
})
```

### QQ 图 {#plot-qqnorm}

```{r faithful-eruptions}
with(data = faithful, {
  long <- eruptions[eruptions > 3]
  par(pty = "s") # arrange for a square figure region
  qqnorm(long, main = "")
  qqline(long)
})
```


### 时序图 {#plot-ts}

时序图最适合用来描述股价走势

```{r,echo=TRUE,fig.cap="1991–1998年间主要欧洲股票市场日闭市价格指数图 \n 德国 DAX (Ibis), Switzerland SMI, 法国 CAC 和 英国 FTSE"}
matplot(time(EuStockMarkets), EuStockMarkets,
  main = "",
  xlab = "Date", ylab = "closing prices",
  pch = 17, type = "l", col = 1:4
)
legend("topleft", colnames(EuStockMarkets), pch = 17, lty = 1, col = 1:4)
```

### 饼图 {#plot-pie}

clockwise 参数

```{r,echo=TRUE}
pie.sales <- c(0.12, 0.3, 0.26, 0.16, 0.04, 0.12)
names(pie.sales) <- c(
  "Blueberry", "Cherry",
  "Apple", "Boston Cream", "Other", "Vanilla Cream"
)
pie(pie.sales, clockwise = TRUE, main = "")
segments(0, 0, 0, 1, col = "red", lwd = 2)
text(0, 1, "init.angle = 90", col = "red")
```


### 茎叶图 {#plot-stem-leaf}

```{r,echo=TRUE}
stem(longley$Unemployed)
```


### 散点图 {#plot-scatter}

在一维空间上，绘制散点图，其实是在看散点的疏密程度随坐标轴的变化

```{r,echo=TRUE,fig.cap="一维散点图",fig.subcap=c("抖动图","疏密图"),fig.asp=0.3}
stripchart(longley$Unemployed, method = "jitter", jitter = 0.1, pch = 16, col = "lightblue")
stripchart(longley$Unemployed, method = "overplot", pch = 16, col = "lightblue")
```

气泡图是二维散点图的一种变体，气泡的大小可以用来描述第三个变量，下面以数据集 topo 为例展示气泡图

```{r,echo=TRUE}
# 加载数据集
data(topo, package = "MASS")
# 查看数据集
str(topo)
```

topo 是空间地形数据集，包含有52行3列，数据点是310平方英尺范围内的海拔高度数据，x 坐标每单位50英尺，y 坐标单位同 x 坐标，海拔高度 z 单位是英尺

```{r,echo=TRUE,fig.cap="地形图之海拔高度",fig.asp=1}
plot(y ~ x,
  cex = (960 - z) / (960 - 690) * 3, data = topo,
  xlab = "X Coordinates", ylab = "Y coordinates"
)
```

散点图也适合分类数据的展示，在图中用不同颜色或符号标记数据点所属类别，即在普通散点图的基础上添加一分类变量的描述

```{r category-base, fig.cap="分类散点图",fig.asp=0.8,echo=TRUE}
plot(mpg ~ hp,
  data = subset(mtcars, am == 1), pch = 16, col = "blue",
  xlim = c(50, 350), ylim = c(10, 35)
)
points(mpg ~ hp,
  col = "red", pch = 16,
  data = subset(mtcars, am == 0)
)
legend(300, 35,
  c("1", "0"),
  title = "am",
  col = c("blue", "red"),
  pch = c(16, 16)
)
```

```{r category-ggplot,fig.cap="分类散点图",echo=TRUE}
ggplot(mtcars, aes(x = hp, y = mpg, color = factor(am))) +
  geom_point() +
  theme_bw()
```

有时为了实现特定的目的，需要高亮其中某些点，按类别或者因子变量分组绘制散点图，这里继续采用 `stripchart` 函数绘制二维散点图\@ref(fig:scatter-iris)， 由左图可知，函数 `stripchart` 提供的参数 `pch` 不接受向量，实际只是取了前三个值 16 16 17 对应于 Species 的三类，关键是高亮的分界点是有区分意义的

```{r scatter-iris, fig.cap="高亮图中部分散点",out.width="35%",fig.asp=1,fig.width=3.5}
data("iris")
pch <- rep(16, length(iris$Petal.Length))
pch[which(iris$Petal.Length < 1.4)] <- 17
stripchart(Petal.Length ~ Species,
  data = iris,
  vertical = TRUE, method = "jitter",
  pch = pch
)
# 对比一下
stripchart(Petal.Length ~ Species,
  data = iris, subset = Petal.Length > 1.4,
  vertical = TRUE, method = "jitter", ylim = c(1, 7),
  pch = 16
)
stripchart(Petal.Length ~ Species,
  data = iris, subset = Petal.Length < 1.4,
  vertical = TRUE, method = "jitter", add = TRUE,
  pch = 17, col = "red"
)
```

如果存在大量散点

```r
densCols(x, y = NULL, nbin = 128, bandwidth,
         colramp = colorRampPalette(blues9[-(1:3)]))
```

`densCols` 函数根据点的局部密度生成颜色，密度估计采用核平滑法，由 **KernSmooth** 包的 `bkde2D` 函数实现。参数 `colramp` 传递一个函数，`colorRampPalette` 根据给定的几种颜色生成函数，参数 `bandwidth` 实际上是传给 `bkde2D` 函数

```{r densCols,fig.cap="根据点的密度生成颜色",fig.asp=1,out.width="45%",fig.width=4.5}
x1 <- matrix(rnorm(1e3), ncol = 2)
x2 <- matrix(rnorm(1e3, mean = 3, sd = 1.5), ncol = 2)
x <- rbind(x1, x2)
dcols <- densCols(x)
graphics::plot(x, col = dcols, pch = 20, panel.first = grid())
# title(main = "n = 1000", xpd = TRUE)
```



### 箱线图 {#plot-box}

```{r boxplot,echo=TRUE}
A <- c(
  79.98, 80.04, 80.02, 80.04, 80.03, 80.03, 80.04, 79.97,
  80.05, 80.03, 80.02, 80, 80.02
)
B <- c(80.02, 79.94, 79.98, 79.97, 79.97, 80.03, 79.95, 79.97)
boxplot(A, B)
```

```{r iris,fig.cap="安德森的鸢尾花数据",fig.asp=1,echo=TRUE}
with(data = iris, {
  op <- par(mfrow = c(2, 2), mar = c(4, 4, 2, .5))
  plot(Sepal.Length ~ Species)
  plot(Sepal.Width ~ Species)
  plot(Petal.Length ~ Species)
  plot(Petal.Width ~ Species)
  par(op)
  mtext("Edgar Anderson's Iris Data", side = 3, line = 4)
})
```

箱线图的花样也很多

```{r,echo=TRUE}
boxplot(longley$Unemployed)
# 水平放置
boxplot(longley$Unemployed,
  horizontal = TRUE,
  col = "pink",
  main = ""
)
```

```{r,echo=TRUE}
data(InsectSprays)
boxplot(count ~ spray,
  data = InsectSprays,
  col = "pink",
  xlab = "Spray",
  ylab = "Count",
  main = ""
)
```

水平放置

```{r,echo=TRUE}
boxplot(count ~ spray,
  data = InsectSprays,
  col = "pink",
  horizontal = TRUE,
  las = 1, # Horizontal labels
  xlab = "Count",
  ylab = "Spray",
  main = ""
)
```


### 提琴图 {#plot-violin}

Tom Kelly 维护的 vioplot 包 <https://github.com/TomKellyGenetics/vioplot>

### 热力图 {#plot-heatmap}

ggplot2

geom\_density()


### 岭线图 {#plot-ridges}

ggridges


### 轮廓图 {#plot-contour}

topo 是地形数据

等高线图

### 折线图 {#plot-line}

函数曲线，样条曲线，核密度曲线，平行坐标图

太阳黑子活动数据

sunspot.month          Monthly Sunspot Data, from 1749 to "Present"
sunspot.year           Yearly Sunspot Data, 1700-1988
sunspots               Monthly Sunspot Numbers, 1749-1983

### 函数图 {#function}

```{r,echo=TRUE,title.mar=TRUE,fig.asp=1,out.width="65%",fig.width=6.5}
library(pracma)
##  First zero on the critical line s = 0.5 + i t
x <- seq(0, 20, len=1001)
z <- 0.5 + x*1i
fr <- Re(zeta(z))
fi <- Im(zeta(z))
fa <- abs(zeta(z))
plot(x, fa, type="n", xlim = c(0, 20), ylim = c(-1.5, 2.5),
     xlab = "Imaginary part (on critical line)", ylab = "Function value",
     main = "Riemann's Zeta Function along the critical line")
grid()	 
lines(x, fr, col="blue")
lines(x, fi, col="darkgreen")
lines(x, fa, col = "red", lwd = 2)
points(14.1347, 0, col = "darkred")
legend(0, 2.4, c("real part", "imaginary part", "absolute value"),
       lty = 1, lwd = c(1, 1, 2), col = c("blue", "darkgreen", "red"))
```

还有 eta 函数和 gammaz 函数

### 马赛克图 {#plot-mosaic}

### 矩阵图 {#plot-matrix}

在对角线上添加平滑曲线、密度曲线

```{r,echo=TRUE,fig.asp=1,fig.cap="变量关系"}
pairs(longley,
  gap = 0,
  diag.panel = function(x, ...) {
    par(new = TRUE)
    hist(x,
      col = "light blue",
      probability = TRUE,
      axes = FALSE,
      main = ""
    )
    lines(density(x),
      col = "red",
      lwd = 3
    )
    rug(x)
  }
)
```

### 雷达图 {#plot-radar}

### 玫瑰图 {#plot-rose}

### 地图 {#plot-map}

```{r unemployment,echo=TRUE,fig.cap="2009年美国各城镇失业率"}
# 代码来自 ?map
par(mar = c(0, 0, 2, 0))
library(mapproj)
data(unemp)
data(county.fips)
colors <- c("#F1EEF6", "#D4B9DA", "#C994C7", "#DF65B0", "#DD1C77", "#980043")
unemp$colorBuckets <- as.numeric(cut(unemp$unemp, c(0, 2, 4, 6, 8, 10, 100)))
leg.txt <- c("<2%", "2-4%", "4-6%", "6-8%", "8-10%", ">10%")
cnty.fips <- county.fips$fips[match(
  map("county", plot = FALSE)$names,
  county.fips$polyname
)]
colorsmatched <- unemp$colorBuckets [match(cnty.fips, unemp$fips)]
# draw map
map("county",
  col = colors[colorsmatched], fill = TRUE, resolution = 0,
  lty = 0, projection = "polyconic"
)
map("state",
  col = "white", fill = FALSE, add = TRUE, lty = 1, lwd = 0.2,
  projection = "polyconic"
)
title("unemployment by county, 2009")
legend("bottomleft", leg.txt,
  horiz = FALSE, fill = colors,
  border = "gray"
)
```

## TikZ {#tikz}

> 用 Base R 绘制带有复杂数学公式的图形，tikzDevice 包结合 R Markdown 的使用，引入 LaTeX 绘图引擎 TikZ 主要是借助 LaTeX 对数学符号的强大支持，让R 语言绘制的图形上出现优美的复杂的数学符号表达式 

以 tikzDevice 绘图， `out.width='35%'` 设置一幅子图占页面的宽度，在 `_common.R` 设置页面宽度为 `out.width='70%'`，即全宽图占页面 70\% 的宽度。 `fig.asp=1` 设置子图的长宽比例为 1:1，即正方形。设置图片的宽度，默认是 `fig.width = 6` 相应地，图片的高度是 `fig.height = fig.width * fig.asp = 6 * 0.618 = 3.708` 但是这个比例使得图片上的字很小，所以设置`fig.width=2.5`。设置图形设备 `dev='tikz'`，此时会自动调用 tikzDevice 包处理图上的数学公式，tikzDevice 包将 LaTeX 中的 TikZ 绘图引擎引入到基础 R 绘图中，由于该引擎将R代码块转化为 `.tex` 文件，接着调用 LaTeX 编译，默认生成 PDF 格式图片，因此设置 `tikz2png='-density 300'` 调用 ImageMgick 的 `convert` 命令将 PDF 格式图片转化为 PNG 格式图片，转化前需要用 Ghostscript 读取该 PDF 文件，转化成功后，需要将该 PNG 格式文件路径返回，以插入到文档中。`bessel-function` 是给该图片的命名，这段代码生成两张图片，两个图片就分别叫做 `bessel-function-1.pdf` 和 `bessel-function-2.pdf`。在 LaTeX 里并排插入两个图片，需要在导言区加载 `subfig` 宏包。

knitr 提供 Tikz 图形的模版， `system.file('misc', 'tikz2pdf.tex', package = 'knitr')`，**tikzDevice** 包 [@R-tikzDevice] 可以方便的把 R 代码转化为 tikz 代码，然后使用 LaTeX 引擎编译成 PDF 文档，特别地，它很好地支持了图里的数学公式

```{r,eval=FALSE}
library(tikzDevice)
tf <- file.path(getwd(), "demo-tikzDevice.tex")

tikz(tf, width = 6, height = 4, pointsize = 30, standAlone = TRUE)
# 绘图的代码，仅支持 Base R Graphics System
source(file = "code/chapter_03/matern.R")
dev.off()

tools::texi2dvi(tf, pdf = T)

system("rm demo-tikzDevice.tex *.log *.aux *.dvi")

system("convert -density 300 -trim demo-tikzDevice.pdf -quality 100 demo-tikzDevice.png")

system("mv demo-tikzDevice.* figures/")
# convert test.svg test.png
```

如图所示

```{r demo-tikzDevice,fig.cap="tikzDevice绘图",echo=FALSE,eval=FALSE}
knitr::include_graphics(path = "figures/demo-tikzDevice.png")
```

两个利用 tikzDevice 包的例子

```{r linear-model,dev='tikz',fig.cap="线性回归模型",out.width="35%",fig.asp=1,fig.width=3.5,tikz2png='-quality 100 -density 300',fig.process=to_png,echo=TRUE,eval=identical(.Platform$OS.type,'unix')}
# 带有图标题
par(mar = c(4.1, 4.1, 4.5, 1.5), ps = 13, family = "Times")
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste("$y = ", round(coef(model)[2], 3),
  "x +", round(coef(model)[1], 3), "$",
  sep = ""
), bty = "n")

plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste("$y = ", round(coef(model)[2], 3),
  "x +", round(coef(model)[1], 3), "$",
  sep = ""
), bty = "n")
```

```{r bessel,dev='tikz',fig.cap="贝塞尔函数",out.width="35%",fig.asp=1,fig.width=2.5,tikz2png='-quality 100 -density 300',fig.process=to_png,eval=identical(.Platform$OS.type,'unix'),echo=TRUE}
x0 <- 2^(-20:10)
nus <- c(0:5, 10, 20)
x <- seq(0, 4, length.out = 501)

plot(x0, x0^-8,
  frame.plot = TRUE, # 添加绘图框
  log = "xy", # x 和 y 轴都取对数尺度
  axes = FALSE, # 去掉坐标轴
  xlab = "$u$",
  ylab = "$\\mathcal{K}_{\\kappa}(u)$", # 设置坐标轴标签
  type = "n", # 清除绘图区域的内容
  ann = TRUE, # 添加标题 x和y轴标签
  panel.first = grid() # 添加背景参考线
)

axis(1,
  at = c(1e-08, 1e-06, 1e-04, 1e-02, 1, 1e+02),
  labels = expression(10^-8, 10^-6, 10^-4, 10^-2, 1, 10^2)
)
axis(2,
  at = c(1e-16, 1, 1e+16, 1e+32, 1e+48),
  labels = expression(10^-16, 1, 10^16, 10^32, 10^48), las = 1
)
# 设置线条颜色
cols <- RColorBrewer::brewer.pal(9, name = "Spectral")
# gray.colors(9) terrain.colors(9)  RColorBrewer::brewer.pal(9,name = "Spectral")
for (i in seq(length(nus)))
  lines(x0, besselK(x0, nu = nus[i]), col = cols[i], lwd = 2)
legend("topright",
  legend = paste0("$\\kappa=", rev(nus), "$"),
  col = rev(cols), lwd = 2, cex = 0.5
)

# 数据变化范围太大，因此横纵坐标轴都取了以10为底的对数，数据可以紧凑的在一张图内展示
x <- seq(0, 40, length.out = 801)
x <- x[x > 0]
plot(x, x,
  frame.plot = TRUE,
  ylim = c(1e-18, 1e11), log = "y", xlab = "$u$", type = "n", yaxt = "n",
  ylab = "$\\mathcal{K}_{\\kappa}(u)$", ann = TRUE, panel.first = grid()
)
axis(2,
  at = c(1e-19, 1e-12, 1e-05, 1e+02, 1e+09),
  labels = expression(10^-19, 10^-12, 10^-5, 10^2, 10^9), las = 1
)

for (i in seq(length(nus)))
  lines(x, besselK(x, nu = nus[i]), col = cols[i], lwd = 2)
legend("topright",
  legend = paste0("$\\kappa=", rev(nus), "$"),
  col = rev(cols), lwd = 2, cex = 0.5
)
```

## 保存 {#save}

保存绘制的图形，R 使用的图形渲染库的版本

```{r,echo=TRUE}
grSoftVersion()
```

当前R环境中支持的图形设备

```{r,echo=TRUE}
capabilities()
```

Table: (\#tab:graphics-devices) 图形设备列表

available     | functional
------------- | -------------
windows       | cairo\_pdf, cairo\_ps
pdf           | svg
postscript    | png
xfig          | jpeg
bitmap        | bmp
pictex        | tiff


```r
apropos("dev.")
```
```
 [1] ".Device"             ".Devices"            "dev.capabilities"   
 [4] "dev.capture"         "dev.control"         "dev.copy"           
 [7] "dev.copy2eps"        "dev.copy2pdf"        "dev.cur"            
[10] "dev.flush"           "dev.hold"            "dev.interactive"    
[13] "dev.list"            "dev.new"             "dev.next"           
[16] "dev.off"             "dev.prev"            "dev.print"          
[19] "dev.set"             "dev.size"            "dev2bitmap"         
[22] "devAskNewPage"       "deviance"            "deviceIsInteractive"
```

## Unicode 字母表 {#letter-numbers}

基础绘图函数，如 plot 标签 `xlab` 支持 Unicode 代码表示的希腊字母，常用字母表备查，公式环境下，也可以用在绘图中

Table: (\#tab:letters) 希腊字母表

 希腊字母      | LaTeX 代码     | Unicode 代码 |  希腊字母   |  LaTeX 代码   |  Unicode 代码
:------------- | :------------- | :----------- | :---------- | :------------ | :-------------
 $\alpha$      | `\alpha`       | `\u03B1`     |  $\mu$      | `\mu`         |   `\u03BC`
 $\beta$       | `\beta`        | `\u03B2`     |  $\nu$      | `\nu`         |   `\u03BD`
 $\gamma$      | `\gamma`       | `\u03B3`     |  $\xi$      | `\xi`         |   `\u03BE`
 $\delta$      | `\delta`       | `\u03B4`     |  $\varphi$  | `\varphi`     |   `\u03C6`
 $\epsilon$    | `\epsilon`     | `\u03B5`     |  $\pi$      | `\pi`         |   `\u03C0`
 $\zeta$       | `\zeta`        | `\u03B6`     |  $\rho$     | `\rho`        |   `\u03C1`
 $\eta$        | `\eta`         | `\u03B7`     |  $\upsilon$ | `\upsilon`    |   `\u03C5`
 $\theta$      | `\theta`       | `\u03B8`     |  $\phi$     | `\phi`        |   `\u03C6`
 $\iota$       | `\iota`        | `\u03B9`     |  $\chi$     | `\chi`        |   `\u03C7`
 $\kappa$      | `\kappa`       | `\u03BA`     |  $\psi$     | `\psi`        |   `\u03C8`
 $\lambda$     | `\lambda`      | `\u03BB`     |  $\omega$   | `\omega`      |   `\u03C9`
 $\sigma$      | `\sigma`       | `\u03C3`     |  $\tau$     | `\tau`        |   `\u03C4`  
 
Table: (\#tab:super-sub-script) 数字上下标

  上标数字 | LaTeX 代码| Unicode 代码 | 下标数字   | LaTeX 代码 |  Unicode 代码
:--------- |:--------- | :---------   | :--------- | :--------- | :---------
 ${}^0$    | `{}^0`    |   `\u2070`   |   ${}_0$   |   `{}_0`   |  `\u2080`
 ${}^1$    | `{}^1`    |   `\u00B9`   |   ${}_1$   |   `{}_1`   |  `\u2081`
 ${}^2$    | `{}^2`    |   `\u00B2`   |   ${}_2$   |   `{}_2`   |  `\u2082`
 ${}^3$    | `{}^3`    |   `\u00B2`   |   ${}_3$   |   `{}_3`   |  `\u2083`
 ${}^4$    | `{}^4`    |   `\u2074`   |   ${}_4$   |   `{}_4`   |  `\u2084`
 ${}^5$    | `{}^5`    |   `\u2075`   |   ${}_5$   |   `{}_5`   |  `\u2085`
 ${}^6$    | `{}^6`    |   `\u2076`   |   ${}_6$   |   `{}_6`   |  `\u2086`
 ${}^7$    | `{}^7`    |   `\u2077`   |   ${}_7$   |   `{}_7`   |  `\u2087`
 ${}^8$    | `{}^8`    |   `\u2078`   |   ${}_8$   |   `{}_8`   |  `\u2088`
 ${}^9$    | `{}^9`    |   `\u2079`   |   ${}_9$   |   `{}_9`   |  `\u2089`
 ${}^n$    | `{}^n`    |   `\u207F`   |   ${}_n$   |   `{}_n`   |  -

其它字母，请查看 [Unicode 字母表][unicode-tab]

[unicode-tab]: https://www.ssec.wisc.edu/~tomw/java/unicode.html
