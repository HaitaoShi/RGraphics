# 图形 {#base}

作为知识介绍，本章所有数据都来源于基础 R 包，即安装 R 软件后自带的数据集，图库在以 base R 中的数据集介绍完后，以相应真实数据扩展为案列

准备好以下绘制统计图形的 R 包

```{r load-pkgs,echo=TRUE}
library(grid)
library(lattice)
library(ggplot2)
```

## 要素 {#elements} 

点线面

点 pch cex 点的类型和大小  col 
线 lty lwd 线的类型和宽度  col 

颜色 col 连续型和离散型
面/多边形 rect 颜色填充

点、线、多边形和圆聚集在图 \@ref(fig:symbols) 中

```{r symbols,fig.cap="多边形和符号元素",echo=TRUE}
# https://jeroen.github.io/uros2018/#23
plot.new()
plot.window(xlim = c(0, 100), ylim = c(0, 100))
polygon(c(10, 40, 80), c(10, 80, 40), col = 'hotpink')
text(40, 90, labels = 'My drawing', col = 'navyblue', cex = 3)
symbols(c(70, 80, 90), c(20, 50, 80), circles = c(10, 20, 10),
        bg = c('yellow', 'orange', 'red'), add = TRUE, lty = 'dashed')
```


## 图库 {#gallary}







### 条形图 {#bar-plot}

### 直方图 {#histograms}



### 时序图 {#time-series-plot}

### 饼图 {#pie-plot}



### 茎叶图 {#stem-leaf-plot}

### 抖动图 {#jitter-plot}

在 base R 中实现的图形，附上 ggplot2 的实现，而 ggplot2 的章节图形提供 base R 实现的图形

强调图对应的数据类型

### 散点图 {#scatter-plot}

```{r,echo=TRUE}
data(topo, package="MASS")
```

topo Spatial Topographic Data是地形数据 The topo data frame has 52 rows and 3 columns, of topographic heights within a 310 feet square.

x coordinates (units of 50 feet)
y coordinates (units of 50 feet)
z heights (feet)


#### 分类散点图  

在图中用不同颜色或符号标记数据点所属类别，即在普通散点图的基础上添加一分类变量的描述

```{r category-base, fig.cap="分类散点图"}
plot(mpg ~ hp,
  data = subset(mtcars, am == 1), pch = 16, col = "blue",
  xlim = c(50, 350), ylim = c(10, 35)
)
points(mpg ~ hp,
  col = "red", pch = 16,
  data = subset(mtcars, am == 0)
)
legend(300, 35,
  c("1", "0"),
  title = "am",
  col = c("blue", "red"),
  pch = c(16, 16)
)
```

```{r category-ggplot,fig.cap="分类散点图"}
ggplot(mtcars, aes(x = hp, y = mpg, color = factor(am))) +
  geom_point() +
  theme_bw()
```

### 箱线图 {#box-plot}

boxplot

### 提琴图 {#violin-plot}

Tom Kelly 维护的 vioplot 包
https://github.com/TomKellyGenetics/vioplot

### 热力图 {#heatmap-plot}

ggplot2

geom\_density()


### 岭线图 {#ridge-lines}

ggridges


### 气泡图 {#bubble-plot}

topo 是地形数据

### 轮廓图 {#contour-plot}

topo 是地形数据

等高线图

### 折线图 {#line-plot}

函数曲线，样条曲线，核密度曲线，平行坐标图，时序图



股价走势曲线

EuStockMarkets         Daily Closing Prices of Major European Stock
                       Indices, 1991-1998
其拓展案例

太阳黑子活动数据

sunspot.month          Monthly Sunspot Data, from 1749 to "Present"
sunspot.year           Yearly Sunspot Data, 1700-1988
sunspots               Monthly Sunspot Numbers, 1749-1983

### 马赛克图 {#mosaic-plot}

### 矩阵树图 {#treemap}

### 雷达图 {#radar-plot}

### 玫瑰图 {#rose-plot}

## 配色 {#colors}

调色板合集 [paletteer](https://github.com/EmilHvitfeldt/paletteer)，其收录了很多 R 包制作的调色板

R 内置了 `r length(colors(TRUE))` 种不同颜色的名称，下面随机地选取 20 种颜色

```{r,echo=TRUE}
sample(colors(TRUE),20)
```


调制两个色板

```{r color-pal, fig.cap = "桃色至梨色的渐变"}
# Colors from https://github.com/johannesbjork/LaCroixColoR
color_pal <- c("#FF3200", "#E9A17C", "#E9E4A6", "#1BB6AF", "#0076BB", "#172869")
n <- 16
more_colors <- (grDevices::colorRampPalette(color_pal))(n)
scales::show_col(colours = more_colors)
```

```{r fish-hsv-pal, fig.cap="Hue-Saturation-Value (HSV) color model"}
# colors in colortools from http://www.gastonsanchez.com/
fish_pal <- c("#69D2E7", "#6993E7", "#7E69E7", "#BD69E7", 
              "#E769D2", "#E76993", "#E77E69", "#E7BD69", 
              "#D2E769", "#93E769", "#69E77E", "#69E7BD")
more_colors <- (grDevices::colorRampPalette(fish_pal))(n)
scales::show_col(colours = more_colors)
```

## 字体 {#fonts}

以常用的新罗马字体为例，在 R 绘图代码中全局设置字体 `par(family="Times")` 或者 `par(family="serif")`，数据集 ais 的含义，散点图 \@ref(fig:times) 表达的统计意义
 
```{r times,out.width="45%",fig.width=27/7,fig.asp=1,dev.args=list(family = "serif"),cache=FALSE}
data(ais, package = 'DAAG')
plot(hg ~ rcc,
  data = ais,
  xlab = expression("Red cell count (" * 10^12 * italic(l)^{
    -1
  } * ")"),
  ylab = expression("Hemaglobin (" * g * dot(" ") * daL^{
    -1
  } * ")")
)
```

pdf 设备使用 sans 字体 ArialMT + SymbolMT 字体显示，默认字体，添加代码块设置 `dev.args=list(family = "sans")`

```{r sans,echo=TRUE,out.width = "45%",fig.width=27/7,fig.cap="默认 sans 字体",fig.asp=1}
par(mar=c(4,4,2,1))
x <- seq(-4, 4, len = 101)
y <- cbind(sin(x), cos(x))
matplot(x, y,
  type = "l", xaxt = "n",
  main = expression(paste(
    plain(sin) * phi, "  and  ",
    plain(cos) * phi
  )),
  ylab = expression("sin" * phi, "cos" * phi), # only 1st is taken
  xlab = expression(paste("Phase Angle ", phi)),
  col.main = "blue"
)
axis(1,
  at = c(-pi, -pi / 2, 0, pi / 2, pi),
  labels = expression(-pi, -pi / 2, 0, pi / 2, pi)
)
```


```{r,eval=FALSE,echo=TRUE}
CM <- Type1Font(
  "CM",
  c(file.path(
    system.file("fonts", "metrics", package = "fontcm"),
    c(
      "fcmr8a.afm", "fcmb8a.afm", "fcmri8a.afm",
      "fcmbi8a.afm", "cmsyase.afm"
    )
  ))
)
pdfFonts(CM = CM)
```

family 指定字体，默认字体 Helvetica

```{r,eval=FALSE,echo=TRUE}
pdf("cm.pdf", family = "CM", width = 4, height = 4)
par(mar = c(4.1, 4.1, 0.5, 0.5)) 
x <- seq(-4, 4, len = 101)
y <- cbind(sin(x), cos(x))
matplot(x, y,
  type = "l", xaxt = "n",
  main = expression(paste(
    plain(sin) * phi, "  and  ",
    plain(cos) * phi
  )),
  ylab = expression("sin" * phi, "cos" * phi), # only 1st is taken
  xlab = expression(paste("Phase Angle ", phi)),
  col.main = "blue"
)
axis(1,
  at = c(-pi, -pi / 2, 0, pi / 2, pi),
  labels = expression(-pi, -pi / 2, 0, pi / 2, pi)
)
dev.off()
```

```{r missing-fonts,fig.cap="字体缺失",eval=FALSE}
knitr::include_graphics(path = "figures/missing-fonts.png")
```


```{r,eval=FALSE,echo=TRUE}
Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")
# embedFonts(file = "cm.pdf", outfile = "cm-embed.pdf") # GS 默认搜索路径不对
embedFonts(
  file = "cm.pdf", outfile = "cm-embed.pdf",
  fontpaths = system.file("fonts", package = "fontcm")  # 指定字体搜索路径
)
```

参考 [@Paul_2006_fonts] fontcm 字体

[cmr-fonts]: https://www.stat.auckland.ac.nz/~paul/R/CM/CMR.html

调用系统字体，安装使用网络字体

```{r,eval=FALSE,echo=TRUE}
library(showtext,quietly = TRUE)
showtext_auto()
pdf("google-fonts.pdf")
font_add_google("Alegreya Sans", "aleg")
par(family = "serif")
plot(0:5,0:5, type="n")
text(1:4, 1:4, "Serif", font=1:4, cex = 2)
par(family = "fira-sans")
plot(0:5,0:5, type="n")
text(1:4, 1:4, "Sans", font=1:4, cex = 2)
dev.off()
```


**knitr** 支持的引擎有：

```{r,echo=TRUE}
names(knitr::knit_engines$get())
```

导入系统TTF类型字体到 R 环境中，这样绘图可以使用更多的字体

```{r,echo=TRUE,eval=FALSE}
install.packages('extrafont')
library(extrafont)
font_import()
# 查看可用的字体
# Vector of font family names
fonts()
# Show entire table
fonttable()
# 加载字体

# Only necessary in session where you ran font_import()
loadfonts()
# For PostScript output, use loadfonts(device="postscript")
# Suppress output with loadfonts(quiet=TRUE)
```

测试字体是否被正确调用

```{r,echo=TRUE,eval=FALSE}
pdf("font_Impact.pdf", family="Impact", width=4, height=4)
par(mar = c(4.1, 4.1, 2.1, 0.5)) 
plot(mtcars$mpg, mtcars$wt, 
     main = "Fuel Efficiency of 32 Cars",
     xlab = "Weight (x1000 lb)",
     ylab = "Miles per Gallon")
dev.off()
```

PDF 格式图片转 PNG 格式

```bash
convert -quality 100 -density 300x300 font_Impact.pdf font_Impact.png
```

```{r fonts-Impact,fig.cap="Impact 字体"}
knitr::include_graphics(path = "figures/font_Impact.png")
```


## TikZ {#tikz}

> 用 Base R 绘制带有复杂数学公式的图形，tikzDevice 包结合 R Markdown 的使用，引入 LaTeX 绘图引擎 TikZ 主要是借助 LaTeX 对数学符号的强大支持，让R 语言绘制的图形上出现优美的复杂的数学符号表达式 

以 tikzDevice 绘图， `out.width='35%'` 设置一幅子图占页面的宽度，在 `_common.R` 设置页面宽度为 `out.width='70%'`，即全宽图占页面 70\% 的宽度。 `fig.asp=1` 设置子图的长宽比例为 1:1，即正方形。设置图片的宽度，默认是 `fig.width = 6` 相应地，图片的高度是 `fig.height = fig.width * fig.asp = 6 * 0.618 = 3.708` 但是这个比例使得图片上的字很小，所以设置`fig.width=2.5`。设置图形设备 `dev='tikz'`，此时会自动调用 tikzDevice 包处理图上的数学公式，tikzDevice 包将 LaTeX 中的 TikZ 绘图引擎引入到基础 R 绘图中，由于该引擎将R代码块转化为 `.tex` 文件，接着调用 LaTeX 编译，默认生成 PDF 格式图片，因此设置 `tikz2png='-density 300'` 调用 ImageMgick 的 `convert` 命令将 PDF 格式图片转化为 PNG 格式图片，转化前需要用 Ghostscript 读取该 PDF 文件，转化成功后，需要将该 PNG 格式文件路径返回，以插入到文档中。`bessel-function` 是给该图片的命名，这段代码生成两张图片，两个图片就分别叫做 `bessel-function-1.pdf` 和 `bessel-function-2.pdf`。在 LaTeX 里并排插入两个图片，需要在导言区加载 `subfig` 宏包。

knitr 提供 Tikz 图形的模版， `system.file('misc', 'tikz2pdf.tex', package = 'knitr')`，**tikzDevice** 包 [@R-tikzDevice] 可以方便的把 R 代码转化为 tikz 代码，然后使用 LaTeX 引擎编译成 PDF 文档，特别地，它很好地支持了图里的数学公式

```{r,eval=FALSE}
library(tikzDevice)
tf <- file.path(getwd(), "demo-tikzDevice.tex")

tikz(tf, width = 6, height = 4, pointsize = 30, standAlone = TRUE)
# 绘图的代码，仅支持 Base R Graphics System
source(file = "code/chapter_03/matern.R")
dev.off()

tools::texi2dvi(tf, pdf = T)

system("rm demo-tikzDevice.tex *.log *.aux *.dvi")

system("convert -density 300 -trim demo-tikzDevice.pdf -quality 100 demo-tikzDevice.png")

system("mv demo-tikzDevice.* figures/")
# convert test.svg test.png
```

如图所示

```{r demo-tikzDevice,fig.cap="tikzDevice绘图",echo=FALSE,eval=FALSE}
knitr::include_graphics(path = "figures/demo-tikzDevice.png")
```

两个利用 tikzDevice 包的例子

```{r linear-model,dev='tikz',fig.cap="线性回归模型",out.width="35%",fig.asp=1,fig.width=3.5,tikz2png='-quality 100 -density 300',fig.process=to_png,echo=TRUE,eval=identical(.Platform$OS.type,'unix')}
# 带有图标题
par(mar = c(4.1, 4.1, 4.5, 1.5), ps = 13, family = "Times")
x <- rnorm(10)
y <- x + rnorm(5, sd = 0.25)
model <- lm(y ~ x)
rsq <- summary(model)$r.squared
rsq <- signif(rsq, 4)
plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste("$y = ", round(coef(model)[2], 3),
  "x +", round(coef(model)[1], 3), "$",
  sep = ""
), bty = "n")

plot(x, y, main = "Hello \\LaTeX!", xlab = "$x$", ylab = "$y$")
abline(model, col = "red")
mtext(paste("Linear model: $R^{2}=", rsq, "$"), line = 0.5)
legend("bottomright", legend = paste("$y = ", round(coef(model)[2], 3),
  "x +", round(coef(model)[1], 3), "$",
  sep = ""
), bty = "n")
```

```{r bessel,dev='tikz',fig.cap="贝塞尔函数",out.width="35%",fig.asp=1,fig.width=2.5,tikz2png='-quality 100 -density 300',fig.process=to_png,eval=identical(.Platform$OS.type,'unix'),echo=TRUE}
x0 <- 2^(-20:10)
nus <- c(0:5, 10, 20)
x <- seq(0, 4, length.out = 501)

plot(x0, x0^-8,
  frame.plot = TRUE,                     # 添加绘图框
  log = "xy",                            # x 和 y 轴都取对数尺度
  axes = FALSE,                          # 去掉坐标轴
  xlab = "$u$", 
  ylab = "$\\mathcal{K}_{\\kappa}(u)$",  # 设置坐标轴标签
  type = "n",                            # 清除绘图区域的内容
  ann = TRUE,                            # 添加标题 x和y轴标签
  panel.first = grid()                   # 添加背景参考线
)

axis(1,
     at = c(1e-08, 1e-06, 1e-04, 1e-02, 1, 1e+02),
     labels = expression(10^-8, 10^-6, 10^-4, 10^-2, 1, 10^2)
)
axis(2,
     at = c(1e-16, 1, 1e+16, 1e+32, 1e+48),
     labels = expression(10^-16, 1, 10^16, 10^32, 10^48), las = 1
)
# 设置线条颜色
cols <- RColorBrewer::brewer.pal(9,name = "Spectral")
# gray.colors(9) terrain.colors(9)  RColorBrewer::brewer.pal(9,name = "Spectral")
for (i in seq(length(nus)))
  lines(x0, besselK(x0, nu = nus[i]), col = cols[i], lwd = 2)
legend("topright",legend = paste0("$\\kappa=", rev(nus),"$"),
       col = rev(cols), lwd = 2, cex = 0.5)

# 数据变化范围太大，因此横纵坐标轴都取了以10为底的对数，数据可以紧凑的在一张图内展示
x <- seq(0, 40, length.out = 801)
x <- x[x > 0]
plot(x, x,frame.plot=TRUE,
     ylim = c(1e-18, 1e11), log = "y", xlab = "$u$", type = "n",  yaxt = "n",
     ylab = "$\\mathcal{K}_{\\kappa}(u)$", ann = TRUE, panel.first = grid()
)
axis(2,
     at = c(1e-19, 1e-12, 1e-05, 1e+02, 1e+09),
     labels = expression(10^-19, 10^-12, 10^-5, 10^2, 10^9), las = 1
)

for (i in seq(length(nus)))
  lines(x, besselK(x, nu = nus[i]), col = cols[i], lwd = 2)
legend("topright", legend = paste0("$\\kappa=", rev(nus),"$"), 
       col = rev(cols), lwd = 2, cex = 0.5)
```


## 魔法 {#magic}

旋转坐标轴标签

```{r,eval=FALSE}
# Rotated axis labels in R plots
# https://menugget.blogspot.com/2014/08/rotated-axis-labels-in-r-plots.html
# Example data
tmin <- as.Date("2000-01-01")
tmax <- as.Date("2001-01-01")
tlab <- seq(tmin, tmax, by = "month")
lab <- format(tlab, format = "%Y-%b")
set.seed(111)
x <- seq(tmin, tmax, length.out = 100)
y <- cumsum(rnorm(100))

# Plot
# png("plot_w_rotated_axis_labels.png", height = 3, 
#     width = 6, units = "in", res = 300)
op <- par(mar = c(6, 4, 1, 1))
plot(x, y, t = "l", xaxt = "n", xlab = "")
axis(1, at = tlab, labels = FALSE)
text(
  x = tlab, y = par()$usr[3] - 0.1 * (par()$usr[4] - par()$usr[3]),
  labels = lab, srt = 45, adj = 1, xpd = TRUE
)
par(op)
# dev.off()
```




图形设备管理

Table: (\#tab:graphics-devices) 图形设备列表

available     | functional
------------- | -------------
windows       | cairo\_pdf, cairo\_ps
pdf           | svg
postscript    | png
xfig          | jpeg
bitmap        | bmp
pictex        | tiff


```r
apropos("dev.")
```
```
 [1] ".Device"             ".Devices"            "dev.capabilities"   
 [4] "dev.capture"         "dev.control"         "dev.copy"           
 [7] "dev.copy2eps"        "dev.copy2pdf"        "dev.cur"            
[10] "dev.flush"           "dev.hold"            "dev.interactive"    
[13] "dev.list"            "dev.new"             "dev.next"           
[16] "dev.off"             "dev.prev"            "dev.print"          
[19] "dev.set"             "dev.size"            "dev2bitmap"         
[22] "devAskNewPage"       "deviance"            "deviceIsInteractive"
```



