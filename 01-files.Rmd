# 文件 {#files}

[给出 linux 下的对应命令]{.todo}

```{r,include=FALSE}
library(magrittr) # 提供管道命令 %>%
```

::: sidebar
- sys: Powerful replacements for base::system2 <https://github.com/jeroen/sys>
- fs: Provide cross platform file operations based on libuv <https://github.com/r-lib/fs>
:::

## 查看 {#list}

文件夹只包含文件，目录既包含文件又包含文件夹，`list.dirs` 列出目录或文件夹，`list.files` 列出文件或文件夹 

*  `list.dirs(path = ".", full.names = TRUE, recursive = TRUE)`
   +  path: 指定完整路径名，默认使用当前路径 `getwd()`
   +  full.names: TRUE 返回相对路径，FALSE 返回目录的名称
   +  recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

   ```{r,echo=TRUE}
   # list.dirs(path = '.',full.names = TRUE,recursive = TRUE)
   list.dirs(path = '.',full.names = TRUE,recursive = FALSE)
   list.dirs(path = '.',full.names = FALSE,recursive = FALSE)
   ```

*  `list.files(path = ".", pattern = NULL, all.files = FALSE, full.names = FALSE, recursive = FALSE,ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)`

   是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

   +  path: 指定完整路径名，默认使用当前路径 `getwd()`
   +  full.names: TRUE 返回相对路径，FALSE 返回目录的名称
   +  recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

* `file.show(..., header = rep("", nfiles), title = "R Information", delete.file = FALSE, pager = getOption("pager"),encoding = "")` 

   打开文件内容，`file.show` 会在R终端中新开一个窗口显示文件，如图\@ref(fig:show-file)所示

    ```{r,echo=TRUE}
    rinternals <- file.path(R.home("include"), "Rinternals.h")
    # file.show(rinternals)
    ```
    ```{r show-file,fig.cap = "file.show 打开文件"}
    knitr::include_graphics(path = 'figures/show-file.png')
    ```

* `file.info(..., extra_cols = TRUE)` 

   获取文件信息，此外 `file.mode(...)` 、 `file.mtime(...)` 和 `file.size(...)` 分别表示文件的读写权限，修改时间和文件大小。

    ```{r,echo=TRUE}
    file.info(rinternals)
    file.mode(rinternals)
    file.mtime(rinternals)
    file.size(rinternals)
    # 查看当前目录的权限
    file.info(".")
    # 查看指定目录权限
    file.info("./_book/")    
    ```

* `file.access(names, mode = 0)`  

   文件是否可以被访问，第二个参数 mode 一共有四种取值 0，1，2，4，分别表示文件的存在性，可执行，可写和可读四种，返回值 0 表示成功，返回值 -1 表示失败。

    ```{r,echo=TRUE}
    file.access(rinternals,mode = 0)
    file.access(rinternals,mode = 1)
    file.access(rinternals,mode = 2)
    file.access(rinternals,mode = 4)
    ```

* `dir(path = ".", pattern = NULL, all.files = FALSE, full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)`
   
   查看目录，首先看看和目录操作有关的函数列表

    ```{r,echo=TRUE}
    apropos("^dir.")
    ```
    
   显而易见，`dir.create` 和 `dir.exists` 分别是创建目录和查看目录的存在性。`dirname` 和 `basename` 是一对函数用来操作文件路径。以当前目录`r getwd()`为例，`dirname(getwd())` 返回 `r dirname(getwd())` 而 `basename(getwd())` 返回 `r basename(getwd())`。对于文件路径而言，`dirname(rinternals)` 返回文件所在的目录`r dirname(rinternals)`， `basename(rinternals)` 返回文件名`r basename(rinternals)`。`dir` 函数查看指定路径或目录下的文件，支持以模式匹配和递归的方式查找目录下的文件

    ```{r,echo=TRUE,out.lines=6}
    # 当前目录下的子目录和文件
    dir()
    # 查看指定目录的子目录和文件
    dir(path = "./")
    # 只列出以字母R开头的子目录和文件
    dir(path = "./", pattern = "^R")
    # 列出目录下所有目录和文件，包括隐藏文件
    dir(path = "./", all.files = TRUE)
    ```
    ```{r,echo=TRUE}
    # 在临时目录下递归创建一个目录
    dir.create(paste0(tempdir(), "/_book/tmp"), recursive = TRUE)
    ```

## 操作 {#manipulation}

实现文件增删改查的函数如下

```{r,echo=TRUE}
apropos("^file.")
```

1. `file.create(..., showWarnings = TRUE)`

   创建/删除文件，检查文件的存在性
   
    ```{r,echo=TRUE}
    file.create('demo.txt')
    file.exists('demo.txt')
    file.remove('demo.txt')
    file.exists('demo.txt')
    ```

1. `file.rename(from, to)` 文件重命名

    ```{r,echo=TRUE}
    file.create('demo.txt')
    file.rename(from = 'demo.txt', to = 'tmp.txt')
    file.exists('tmp.txt')
    ```

1. `file.append(file1, file2)` 追加文件

1. `file.copy(from, to, overwrite = recursive, recursive = FALSE,copy.mode = TRUE, copy.date = FALSE)` 复制文件

1. `file.symlink(from, to)` 创建符号链接 `file.link(from, to)` 创建硬链接

1. `Sys.junction(from, to)` windows 平台上的函数，提供类似符号链接的功能

1. `Sys.readlink(paths)` 读取文件的符号链接（软链接）

1. `choose.files` 交互式选择文件 

1. `download.file` 文件下载


```{r,include=FALSE}
# 清理临时创建的文件
files <- c("demo.txt", "tmp.txt") # 指向文件路径
if (any(file.exists(files))) file.remove(files[file.exists(files)])
```

## 压缩 {#compression}


R 函数


命令行

`tar/untar` 与 `zip/unzip`

1. 将 `.csv` 文件压缩成 `.tar.bz2` 格式

   ```bash
   tar -cjf clientip.tar.bz2 clientip.csv
   ```

1. 当前目录下，将目录 `rstan/` 下的所有文件压缩为 `rstan.tar.gz` 文件

   ```bash
   tar -czf rstan.tar.gz ./rstan/*
   ```

1. tar 解压

    ```bash
    tar -xzf R-3.5.1.tar.gz
    ```


tar 参数列表

1. `-v` 解压过程中显示文件


## 路径 {#paths}

环境变量算是路径操作

```{r,echo=TRUE}
# 获取环境变量
Sys.getenv("PATH")
# 设置环境变量 Windows
# Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")
# 设置 pandoc 环境变量
pandoc_path <- Sys.getenv("RSTUDIO_PANDOC", NA)
if (Sys.which("pandoc") == "" && !is.na(pandoc_path)) {
  Sys.setenv(PATH = paste(
    Sys.getenv("PATH"), pandoc_path,
    sep = if (.Platform$OS.type == "unix") ":" else ";"
  ))
}
```

操作文件路径

1. `file.path` Construct Path to File

    ```{r,echo=TRUE}
    file.path('./_book')
    ```

1. `path.expand(path)` Expand File Paths

    ```{r,echo=TRUE}
    path.expand('./_book')
    path.expand('~')
    ```

1. `normalizePath()` Express File Paths in Canonical Form

    ```{r,echo=TRUE}
    normalizePath('~')
    normalizePath('./_book')
    ```

1. `shortPathName(path)`  只在 Windows 下可用，Express File Paths in Short Form

    ```{r,echo=TRUE,eval=identical(.Platform$OS.type,'windows')}
    cat(shortPathName(c(R.home(), tempdir())), sep = "\n")
    ```

1. `Sys.glob`  Wildcard Expansion on File Paths

    ```{r,echo=TRUE,out.lines=6}
    Sys.glob(file.path(R.home(), "library", "*", "R", "*.rdx")) 
    ```

## 查找 {#find}

查找文件、可执行文件的完整路径、R 包

1. `Sys.which` Find Full Paths to Executables
1. `system.file`  Find Names of R System Files
1. `R.home`
1. `.libPaths()`
1. `find.package`
1. `file.exist`

## 权限 {#permissions}

操作目录和文件的权限 Manipulation of Directories and File Permissions

dir.exists(paths)
dir.create(path, showWarnings = TRUE, recursive = FALSE, mode = "0777")
Sys.chmod(paths, mode = "0777", use_umask = TRUE)
Sys.umask(mode = NA)

## 区域 {#locale}

Query or Set Aspects of the Locale

Sys.getlocale(category = "LC_ALL")
Sys.setlocale(category = "LC_ALL", locale = "")
Sys.localeconv

Find Details of the Numerical and Monetary Representations in the Current Locale

## 进程 {#process}

聊聊什么是进程，线程

Sys.getpid Get the Process ID of the R Session

proc.time()          Running Time of R/ for the timings for the session.
system.time         for measuring elapsed/CPU time of expressions.
gc.time             Report Time Spent in Garbage Collection




## 调用 {#system}

`system` 和 `system2` 系统命令 Invoke a System Command

## 时间 {#time}

`Sys.timezone` 获取时区信息

```{r,echo=TRUE}
Sys.timezone(location = TRUE)
```

`Sys.time` 系统时间，可以给定时区下，显示当前时间，精确到秒，返回数据类型为 `POSIXct`

```{r,echo=TRUE}
# 此时美国洛杉矶时间
format(Sys.time(), tz = 'America/Los_Angeles', usetz = TRUE)
# 此时加拿大东部时间
format(Sys.time(), tz = 'Canada/Eastern', usetz = TRUE)
```

`Sys.Date` 显示当前时区下的日期，精确到日，返回数据类型为 `date`

```{r,echo=TRUE}
Sys.Date()
```

`date` 返回当前系统日期和时间，数据类型是字符串

```{r,echo=TRUE}
date()
## 也可以这样表示
format(Sys.time(), "%a %b %d %H:%M:%S %Y")
```

`as.POSIX*` 是一个 Date-time 转换函数

```{r,echo=TRUE}
as.POSIXlt(Sys.time(), "GMT") # the current time in GMT
```

时间计算

```{r,echo=TRUE}
(z <- Sys.time())             # the current date, as class "POSIXct"

Sys.time() - 3600             # an hour ago
```

`.leap.seconds` 是内置的日期序列

```{r,echo=TRUE}
.leap.seconds
```

计算日期对应的星期`weekdays`，月 `months` 和季度 `quarters`

```{r,echo=TRUE}
weekdays(.leap.seconds)
months(.leap.seconds)
quarters(.leap.seconds)
```

`Sys.setFileTime()`

```{r,echo=TRUE}
# 存放时区信息的数据库位置
file.path(R.home("share"), "zoneinfo")
strptime(Sys.time(), format ="%Y-%m-%d %H:%M:%S", tz = "Asia/Taipei")
```

## 搜索 {#search}

help.search
?regrex

## R 包 {#package}

```{r,echo=TRUE}
apropos('package')
```

1. `.packages(T)` 已安装的 R 包

    ```{r,echo=TRUE}
    .packages(T) %>% length()
    ```
   
1. `available.packages` 查询可用的 R 包

    ```{r,echo=TRUE}
    available.packages()[,"Package"] %>% head()
    ```
    
    查询 repos 的 R 包
    
    ```{r,echo=TRUE,eval=FALSE}
    rforge <- available.packages(repos = "https://r-forge.r-project.org/")
    cran <- available.packages(repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/")
    setdiff(rforge[, "Package"], cran[, "Package"])
    ```

1. `download.packages` 下载 R 包

    ```{r,echo=TRUE,eval=FALSE}
    download.packages("Rbooks", destdir = "~/", repos = "https://r-forge.r-project.org/")
    ```

1. `install.packages` 安装 R 包

    ```{r,echo=TRUE,eval=FALSE}
    install.packages("bookdown")
    ```

1. `installed.packages` 已安装的 R 包

    ```{r,echo=TRUE,eval=FALSE}
    installed.packages(fields = c("Package","Version")) %>% head()
    ```

1. `remove.packages` 卸载/删除/移除已安装的R包

    ```{r,echo=TRUE,eval=FALSE}
    remove.packages('bookdown')
    ```
 
1. `update.packages` 更新已安装的 R 包

    ```{r,echo=TRUE,eval=FALSE}
    update.packages(ask = FALSE)
    ```

1. `old.packages` 查看过时/可更新的 R 包

    ```{r,echo=TRUE}
    old.packages() %>% head()
    ```

1. `new.packages` 还没有安装的 R 包 

    ```{r,echo=TRUE}
    new.packages() %>% head()
    ```

1. `packageStatus` 查看已安装的 R 包状态，可更新、可下载等

    ```{r,echo=TRUE}
    packageStatus()
    ```
    
1. `packageDescription` 查询 R 包描述信息

    ```{r,echo=TRUE,out.lines=6}
    packageDescription('bookdown')
    ```

1. 查询 R 包的依赖关系

    ```{r,echo=TRUE,eval=require('bookdown')}
    # bookdown 依赖的 R 包
    tools::package_dependencies('bookdown', recursive = TRUE)
    # 依赖 bookdown 的 R 包
    tools::dependsOnPkgs('bookdown', recursive = TRUE)
    ```
    
    ggplot2 生态，仅列出以 gg 开头的 R 包
    
    ```{r,echo=TRUE}
    pdb <- available.packages()
    gg <- tools::dependsOnPkgs("ggplot2", recursive = FALSE, installed = pdb)
    grep("^gg", gg, value = TRUE)
    ```
    

1. 重装R包，与 R 版本号保持一致

    ```{r,echo=TRUE,eval=FALSE}
    db <- installed.packages()
    db <- as.data.frame(db, stringsAsFactors = FALSE)
    pkgs <- db[db$Built < getRversion(), "Package"]
    install.packages(pkgs)
    ```



