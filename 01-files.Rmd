# 文件 {#files}

[给出 linux 下的对应命令]{.todo}

```{r,include=FALSE}
library(magrittr) # 提供管道命令 %>%
```

::: sidebar
- sys: Powerful replacements for base::system2 <https://github.com/jeroen/sys>
- fs: Provide cross platform file operations based on libuv <https://github.com/r-lib/fs>
:::

## 查看 {#list}

文件夹只包含文件，目录既包含文件又包含文件夹，`list.dirs` 列出目录或文件夹，`list.files` 列出文件或文件夹 

*  `list.dirs(path = ".", full.names = TRUE, recursive = TRUE)`
   +  path: 指定完整路径名，默认使用当前路径 `getwd()`
   +  full.names: TRUE 返回相对路径，FALSE 返回目录的名称
   +  recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

   ```{r,echo=TRUE}
   # list.dirs(path = '.',full.names = TRUE,recursive = TRUE)
   list.dirs(path = '.',full.names = TRUE,recursive = FALSE)
   list.dirs(path = '.',full.names = FALSE,recursive = FALSE)
   ```

*  `list.files(path = ".", pattern = NULL, all.files = FALSE, full.names = FALSE, recursive = FALSE,ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)`

   是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

   +  path: 指定完整路径名，默认使用当前路径 `getwd()`
   +  full.names: TRUE 返回相对路径，FALSE 返回目录的名称
   +  recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

* `file.show(..., header = rep("", nfiles), title = "R Information", delete.file = FALSE, pager = getOption("pager"),encoding = "")` 

   打开文件内容，`file.show` 会在R终端中新开一个窗口显示文件，如图\@ref(fig:show-file)所示

    ```{r,echo=TRUE}
    rinternals <- file.path(R.home("include"), "Rinternals.h")
    # file.show(rinternals)
    ```
    ```{r show-file,fig.cap = "file.show 打开文件"}
    knitr::include_graphics(path = 'figures/show-file.png')
    ```

* `file.info(..., extra_cols = TRUE)` 

   获取文件信息，此外 `file.mode(...)` 、 `file.mtime(...)` 和 `file.size(...)` 分别表示文件的读写权限，修改时间和文件大小。

    ```{r,echo=TRUE}
    file.info(rinternals)
    file.mode(rinternals)
    file.mtime(rinternals)
    file.size(rinternals)
    # 查看当前目录的权限
    file.info(".")
    # 查看指定目录权限
    file.info("./_book/")    
    ```

* `file.access(names, mode = 0)`  

   文件是否可以被访问，第二个参数 mode 一共有四种取值 0，1，2，4，分别表示文件的存在性，可执行，可写和可读四种，返回值 0 表示成功，返回值 -1 表示失败。

    ```{r,echo=TRUE}
    file.access(rinternals,mode = 0)
    file.access(rinternals,mode = 1)
    file.access(rinternals,mode = 2)
    file.access(rinternals,mode = 4)
    ```

* `dir(path = ".", pattern = NULL, all.files = FALSE, full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)`
   
   查看目录，首先看看和目录操作有关的函数列表

    ```{r,echo=TRUE}
    apropos("^dir.")
    ```
    
   显而易见，`dir.create` 和 `dir.exists` 分别是创建目录和查看目录的存在性。`dirname` 和 `basename` 是一对函数用来操作文件路径。以当前目录`r getwd()`为例，`dirname(getwd())` 返回 `r dirname(getwd())` 而 `basename(getwd())` 返回 `r basename(getwd())`。对于文件路径而言，`dirname(rinternals)` 返回文件所在的目录`r dirname(rinternals)`， `basename(rinternals)` 返回文件名`r basename(rinternals)`。`dir` 函数查看指定路径或目录下的文件，支持以模式匹配和递归的方式查找目录下的文件

    ```{r,echo=TRUE,out.lines=6}
    # 当前目录下的子目录和文件
    dir()
    # 查看指定目录的子目录和文件
    dir(path = "./")
    # 只列出以字母R开头的子目录和文件
    dir(path = "./", pattern = "^R")
    # 列出目录下所有目录和文件，包括隐藏文件
    dir(path = "./", all.files = TRUE)
    ```
    ```{r,echo=TRUE}
    # 在临时目录下递归创建一个目录
    dir.create(paste0(tempdir(), "/_book/tmp"), recursive = TRUE)
    ```

查看当前目录下的文件和文件夹

1. tree 

```bash
tree -L 2 .
```
```
.
├── 01-files.Rmd
├── 02-rio.Rmd
├── 03-manipulate.Rmd
├── 04-graph.Rmd
├── 05-visualization.Rmd
├── 92-regex.Rmd
├── 93-oo.Rmd
├── 94-install.Rmd
├── 95-tools.Rmd
├── 96-references.Rmd
├── DESCRIPTION
├── Makefile
├── README.md
├── RGraphics-tikzDictionary
├── RGraphics.Rproj
├── _book
│   ├── RGraphics.epub
│   ├── RGraphics.pdf
│   ├── RGraphics.tex
│   ├── RGraphics_files
│   ├── base.html
│   ├── css
│   ├── figures
│   ├── files.html
│   ├── index.html
│   ├── install.html
│   ├── libs
│   ├── manipulate.html
│   ├── references.html
│   ├── regex.html
│   ├── search_index.json
│   └── tools.html
├── _bookdown.yml
├── _bookdown_files
│   ├── RGraphics_cache
│   └── RGraphics_files
├── _common.R
├── _deploy.sh
├── _output.yml
├── _render.R
├── css
│   └── style.css
├── figures
│   ├── by-nc-nd.png
│   ├── font_Impact.pdf
│   ├── font_Impact.png
│   ├── gputools.png
│   ├── mai.pdf
│   ├── mai.png
│   ├── msfonts.png
│   ├── oma.pdf
│   ├── show-file.png
│   └── terminal.png
├── images
│   ├── dragon.png
│   └── favicon.ico
├── index.Rmd
├── latex
│   ├── TeXLive.pkgs
│   ├── after_body.tex
│   ├── before_body.tex
│   ├── book.bib
│   ├── preamble.tex
│   ├── refer.bib
│   └── sidebar.lua
├── packages.bib
├── r-packages-logs.md
```

1. ls 

```bash
ls -l
```
```
total 448
-rw-r--r--   1 xiangyun  staff  16793  2 14 17:22 01-files.Rmd
-rw-r--r--@  1 xiangyun  staff   1289  2 12 11:26 02-rio.Rmd
-rw-r--r--   1 xiangyun  staff  14096  2 12 11:25 03-manipulate.Rmd
-rw-r--r--   1 xiangyun  staff  18044  2 14 12:26 04-graph.Rmd
-rw-r--r--   1 xiangyun  staff   2064  2 14 12:26 05-visualization.Rmd
-rw-r--r--@  1 xiangyun  staff   7826  2 12 12:10 92-regex.Rmd
-rw-r--r--@  1 xiangyun  staff   1472  1 29 16:34 93-oo.Rmd
-rw-r--r--   1 xiangyun  staff  22607  2 12 14:33 94-install.Rmd
-rw-r--r--   1 xiangyun  staff  21814  2 12 21:29 95-tools.Rmd
-rw-r--r--@  1 xiangyun  staff     78  1 29 16:34 96-references.Rmd
-rw-r--r--@  1 xiangyun  staff    210  2 11 13:34 DESCRIPTION
-rw-r--r--@  1 xiangyun  staff    143  1 29 16:34 Makefile
-rw-r--r--@  1 xiangyun  staff    704  2 11 13:47 README.md
-rw-r--r--@  1 xiangyun  staff  13080  2 10 14:46 RGraphics-tikzDictionary
-rw-r--r--@  1 xiangyun  staff    242  2 14 17:20 RGraphics.Rproj
drwxr-xr-x  18 xiangyun  staff    576  2 13 17:28 _book
-rw-r--r--   1 xiangyun  staff    608  2 14 12:26 _bookdown.yml
drwxr-xr-x   4 xiangyun  staff    128  2 13 17:28 _bookdown_files
-rw-r--r--   1 xiangyun  staff   2855  2 13 17:26 _common.R
-rw-r--r--@  1 xiangyun  staff    569  1 29 16:34 _deploy.sh
-rw-r--r--@  1 xiangyun  staff    977  1 29 16:34 _output.yml
-rw-r--r--@  1 xiangyun  staff   1639  1 29 16:34 _render.R
drwxr-xr-x@  3 xiangyun  staff     96  1 29 16:34 css
drwxr-xr-x   4 xiangyun  staff    128  2 14 16:01 data
drwxr-xr-x@ 12 xiangyun  staff    384  2 10 14:59 figures
drwxr-xr-x   4 xiangyun  staff    128  2 11 14:46 images
-rw-r--r--   1 xiangyun  staff  18150  2 14 12:26 index.Rmd
drwxr-xr-x@  9 xiangyun  staff    288  2 11 13:41 latex
-rw-r--r--@  1 xiangyun  staff   1328  2 13 17:26 packages.bib
-rw-r--r--@  1 xiangyun  staff  18517  1 29 16:34 r-packages-logs.md
drwxr-xr-x   3 xiangyun  staff     96  2 11 12:58 rsconnect
```

## 操作 {#manipulation}

实现文件增删改查的函数如下

```{r,echo=TRUE}
apropos("^file.")
```

1. `file.create(..., showWarnings = TRUE)`

   创建/删除文件，检查文件的存在性
   
    ```{r,echo=TRUE}
    file.create('demo.txt')
    file.exists('demo.txt')
    file.remove('demo.txt')
    file.exists('demo.txt')
    ```

1. `file.rename(from, to)` 文件重命名

    ```{r,echo=TRUE}
    file.create('demo.txt')
    file.rename(from = 'demo.txt', to = 'tmp.txt')
    file.exists('tmp.txt')
    ```

1. `file.append(file1, file2)` 追加文件 `file2` 的内容到文件 `file1` 上

    ```{r,include=FALSE}
    if(!dir.exists(paths = 'data/')) dir.create(path = 'data/')
    ```
    ```{r,echo=TRUE}
    # 创建两个临时文件
    file.create(c('data/tmp1.md','data/tmp2.md'))
    # 写入内容
    cat("AAA\n", file = 'data/tmp1.md')
    cat("BBB\n", file = 'data/tmp2.md')
    # 追加文件
    file.append(file1 = 'data/tmp1.md', file2 = 'data/tmp2.md')
    # 展示文件内容
    readLines('data/tmp1.md')
    ```

1. `file.copy(from, to, overwrite = recursive, recursive = FALSE,copy.mode = TRUE, copy.date = FALSE)` 复制文件

    ```{r,echo=TRUE}
    file.copy(from = 'Makefile', to = 'data/Makefile')
    ```

1. `file.symlink(from, to)` 创建符号链接 `file.link(from, to)` 创建硬链接

1. `Sys.junction(from, to)` windows 平台上的函数，提供类似符号链接的功能

1. `Sys.readlink(paths)` 读取文件的符号链接（软链接）

1. `choose.files` 在 Windows 环境下交互式地选择一个或多个文件，所以该函数只运行于 Windows 环境

```{r,echo=TRUE,eval=FALSE}
# 选择 zip 格式的压缩文件或其它
if (interactive())
     choose.files(filters = Filters[c("zip", "All"),])
```

`Filters` 参数传递一个矩阵，用来描述或标记R识别的文件类型，上面这个例子就能筛选出 zip 格式的文件

1. `download.file` 文件下载

```{r,echo=TRUE,eval=FALSE}
download.file(url = 'https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R-latest.tar.gz',
              destfile = 'data/R-latest.tar.gz', method = 'auto')
```


```{r,include=FALSE}
# 清理临时创建的文件
files <- c("demo.txt", "tmp.txt") # 指向文件路径
if (any(file.exists(files))) file.remove(files[file.exists(files)])
```

## 压缩 {#compression}

tar 和 zip 是两种常见的压缩文件工具，具有免费和跨平台的特点，因此应用范围广。^[<https://github.com/libarchive/libarchive/wiki/FormatTar>]

1. `tar/untar` 压缩与解压缩

```r
tar(tarfile, files = NULL,
    compression = c("none", "gzip", "bzip2", "xz"),
    compression_level = 6, tar = Sys.getenv("tar"),
    extra_flags = "")
```

比较常用的压缩文件格式是 `.tar.gz` 和 `.tar.bz2`，将目录 `_book/`及其文件分别压缩成 `_book.tar.gz` 和 `_book.tar.bz2` 压缩包的名字可以任意取，后者压缩比率高

```{r,echo=TRUE,eval=FALSE}
# 文件压缩成 _book.tar.gz 格式
# tar -czf _book.tar.gz _book
tar(tarfile = 'data/_book.tar.gz', files = '_book', compression = 'gzip')
# tar -czf _book.tar.gz _book/*
tar(tarfile = 'data/_book.tar.gz', files = '_book/*', compression = 'gzip')
# 文件压缩成 .tar.bz2 格式
# tar -cjf data/book2.tar.bz2 _book
tar(tarfile = 'data/_book.tar.bz2', files = '_book', compression = 'bzip2')
```

```r
untar(tarfile, files = NULL, list = FALSE, exdir = ".",
      compressed = NA, extras = NULL, verbose = FALSE,
      restore_times =  TRUE, tar = Sys.getenv("TAR"))
```



1. `zip/unzip`

命令行形式

1. tar 解压

    ```bash
    tar -xzf R-3.5.1.tar.gz
    ```


tar 参数列表

1. `-v` 解压过程中显示文件


## 路径 {#paths}

环境变量算是路径操作

```{r,echo=TRUE}
# 获取环境变量
Sys.getenv("PATH")
# 设置环境变量 Windows
# Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")
# 设置 pandoc 环境变量
pandoc_path <- Sys.getenv("RSTUDIO_PANDOC", NA)
if (Sys.which("pandoc") == "" && !is.na(pandoc_path)) {
  Sys.setenv(PATH = paste(
    Sys.getenv("PATH"), pandoc_path,
    sep = if (.Platform$OS.type == "unix") ":" else ";"
  ))
}
```

操作文件路径

1. `file.path` Construct Path to File

    ```{r,echo=TRUE}
    file.path('./_book')
    ```

1. `path.expand(path)` Expand File Paths

    ```{r,echo=TRUE}
    path.expand('./_book')
    path.expand('~')
    ```

1. `normalizePath()` Express File Paths in Canonical Form

    ```{r,echo=TRUE}
    normalizePath('~')
    normalizePath('./_book')
    ```

1. `shortPathName(path)`  只在 Windows 下可用，Express File Paths in Short Form

    ```{r,echo=TRUE,eval=identical(.Platform$OS.type,'windows')}
    cat(shortPathName(c(R.home(), tempdir())), sep = "\n")
    ```

1. `Sys.glob`  Wildcard Expansion on File Paths

    ```{r,echo=TRUE,out.lines=6}
    Sys.glob(file.path(R.home(), "library", "*", "R", "*.rdx")) 
    ```

## 查找 {#find}

查找文件、可执行文件的完整路径、R 包

1. `Sys.which` Find Full Paths to Executables

    ```{r,echo=TRUE}
    Sys.which('pandoc')
    ```

1. `system.file`  Find Names of R System Files

    ```{r,echo=TRUE}
    system.file('CITATION',package = 'base')
    ```

1. `R.home`

    ```{r,echo=TRUE}
    # R 安装目录
    R.home()
    # R执行文件目录
    R.home('bin')
    # 配置文件目录
    R.home('etc')
    # R 基础扩展包存放目录
    R.home('library')
    ```

1. `.libPaths()` R 包存放的路径有哪些

    ```{r,echo=TRUE}
    .libPaths()
    ```

1. `find.package` 查找R包所在目录

    ```{r,echo=TRUE}
    find.package(package = 'MASS')
    ```

1. `file.exist` 检查文件是否存在

    ```{r,echo=TRUE}
    file.exists(paste(R.home('etc'),"Rprofile.site",sep = .Platform$file.sep))
    ```

## 权限 {#permissions}

操作目录和文件的权限 Manipulation of Directories and File Permissions

1. `dir.exists(paths)` 检查目录是否存在

    ```{r,echo=TRUE}
    dir.exists(c('./_book','./book'))
    ```

1. `dir.create(path, showWarnings = TRUE, recursive = FALSE, mode = "0777")` 创建目录

    ```{r,echo=TRUE}
    dir.create('./_book/tmp')
    ```

1. `Sys.chmod(paths, mode = "0777", use_umask = TRUE)` 修改权限

    ```{r,echo=TRUE}
    Sys.chmod('./_book/tmp')
    ```

1. `Sys.umask(mode = NA)`

```{r}

```


## 区域 {#locale}

1. `Sys.getlocale(category = "LC_ALL")` 查看当前区域设置

    ```{r,echo=TRUE}
    Sys.getlocale(category = "LC_ALL")
    ```

1. `Sys.setlocale(category = "LC_ALL", locale = "")` 设置区域

    ```{r,echo=TRUE}
    # 默认设置
    Sys.setlocale(category = "LC_ALL", locale = "")
    # 保存当前区域设置
    old <- Sys.getlocale()
    
    Sys.setlocale("LC_MONETARY", locale = "")
    Sys.localeconv()
    Sys.setlocale("LC_MONETARY", "de_AT")
    Sys.localeconv()
    
    # 恢复区域设置
    Sys.setlocale(locale = old)
    ```

1. `Sys.localeconv()` 当前区域设置下，数字和货币的表示

    ```{r,echo=TRUE}
    Sys.localeconv()
    ```

    本地化信息

    ```{r,echo=TRUE}
    l10n_info()
    ```


## 进程 {#process}

- `Sys.getpid` 获取当前运行中的 R 控制台（会话）的进程 ID

    ```{r,echo=TRUE}
    Sys.getpid()
    ```

- `proc.time()` R 会话运行时间，常用于计算R程序在当前R控制台的运行时间

    ```{r,echo=TRUE}
    t1 <- proc.time()
    tmp <- rnorm(1e6)
    proc.time() - t1
    ```

- `system.time` 计算 R 表达式/程序块运行耗费的CPU时间

    ```{r,echo=TRUE}
    system.time({
      rnorm(1e6)
    }, gcFirst = TRUE)
    ```

- `gc.time`  报告垃圾回收耗费的时间

    ```{r,echo=TRUE}
    gc.time()
    ```

## 调用 {#system}

`system` 和 `system2` 系统命令 Invoke a System Command

## 时间 {#time}

1. `Sys.timezone` 获取时区信息

    ```{r,echo=TRUE}
    Sys.timezone(location = TRUE)
    ```

1. `Sys.time` 系统时间，可以给定时区下，显示当前时间，精确到秒，返回数据类型为 `POSIXct`

    ```{r,echo=TRUE}
    # 此时美国洛杉矶时间
    format(Sys.time(), tz = 'America/Los_Angeles', usetz = TRUE)
    # 此时加拿大东部时间
    format(Sys.time(), tz = 'Canada/Eastern', usetz = TRUE)
    ```

1. `Sys.Date` 显示当前时区下的日期，精确到日，返回数据类型为 `date`

    ```{r,echo=TRUE}
    Sys.Date()
    ```

1. `date` 返回当前系统日期和时间，数据类型是字符串

    ```{r,echo=TRUE}
    date()
    ## 也可以这样表示
    format(Sys.time(), "%a %b %d %H:%M:%S %Y")
    ```

1. `as.POSIX*` 是一个 Date-time 转换函数

    ```{r,echo=TRUE}
    as.POSIXlt(Sys.time(), "GMT") # the current time in GMT
    ```

1. 时间计算

    ```{r,echo=TRUE}
    (z <- Sys.time())             # the current date, as class "POSIXct"
    
    Sys.time() - 3600             # an hour ago
    ```

1. `.leap.seconds` 是内置的日期序列

    ```{r,echo=TRUE}
    .leap.seconds
    ```

    计算日期对应的星期`weekdays`，月 `months` 和季度 `quarters`
    
    ```{r,echo=TRUE}
    weekdays(.leap.seconds)
    months(.leap.seconds)
    quarters(.leap.seconds)
    ```

1. `Sys.setFileTime()` 使用系统调用 system call 设置文件或目录的时间

    ```{r,echo=TRUE}
    # 修改时间前
    file.info('./_common.R')
    # 修改时间后，对比一下
    Sys.setFileTime(path = './_common.R', time = Sys.time())
    file.info('./_common.R')
    ```

1. `strptime` 用于字符串与 `POSIXlt`、 `POSIXct` 类对象之间的转化，`format` 默认 `tz = ""` 且 `usetz = TRUE` 

    ```{r,echo=TRUE}
    # 存放时区信息的数据库所在目录
    list.files(file.path(R.home("share"), "zoneinfo"))
    # 比较不同的打印方式
    strptime(Sys.time(), format ="%Y-%m-%d %H:%M:%S", tz = "Asia/Taipei")
    format(Sys.time(), format = "%Y-%m-%d %H:%M:%S") # 默认情形
    format(Sys.time(), format = "%Y-%m-%d %H:%M:%S", tz = "Asia/Taipei", usetz = TRUE)
    ```

## 搜索 {#search}

`help.search`
`?regrex`

## R 包 {#package}

```{r,echo=TRUE}
apropos('package')
```

1. `.packages(T)` 已安装的 R 包

    ```{r,echo=TRUE}
    .packages(T) %>% length()
    ```
   
1. `available.packages` 查询可用的 R 包

    ```{r,echo=TRUE}
    available.packages()[,"Package"] %>% head()
    ```
    
    查询 repos 的 R 包
    
    ```{r,echo=TRUE,eval=FALSE}
    rforge <- available.packages(repos = "https://r-forge.r-project.org/")
    cran <- available.packages(repos = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/")
    setdiff(rforge[, "Package"], cran[, "Package"])
    ```

1. `download.packages` 下载 R 包

    ```{r,echo=TRUE,eval=FALSE}
    download.packages("Rbooks", destdir = "~/", repos = "https://r-forge.r-project.org/")
    ```

1. `install.packages` 安装 R 包

    ```{r,echo=TRUE,eval=FALSE}
    install.packages("bookdown")
    ```

1. `installed.packages` 已安装的 R 包

    ```{r,echo=TRUE,eval=FALSE}
    installed.packages(fields = c("Package","Version")) %>% head()
    ```

1. `remove.packages` 卸载/删除/移除已安装的R包

    ```{r,echo=TRUE,eval=FALSE}
    remove.packages('bookdown')
    ```
 
1. `update.packages` 更新已安装的 R 包

    ```{r,echo=TRUE,eval=FALSE}
    update.packages(ask = FALSE)
    ```

1. `old.packages` 查看过时/可更新的 R 包

    ```{r,echo=TRUE}
    old.packages() %>% head()
    ```

1. `new.packages` 还没有安装的 R 包 

    ```{r,echo=TRUE}
    new.packages() %>% head()
    ```

1. `packageStatus` 查看已安装的 R 包状态，可更新、可下载等

    ```{r,echo=TRUE}
    packageStatus()
    ```
    
1. `packageDescription` 查询 R 包描述信息

    ```{r,echo=TRUE,out.lines=6}
    packageDescription('bookdown')
    ```

1. 查询 R 包的依赖关系

    ```{r,echo=TRUE,eval=require('bookdown')}
    # bookdown 依赖的 R 包
    tools::package_dependencies('bookdown', recursive = TRUE)
    # 依赖 bookdown 的 R 包
    tools::dependsOnPkgs('bookdown', recursive = TRUE)
    ```
    
    ggplot2 生态，仅列出以 gg 开头的 R 包
    
    ```{r,echo=TRUE}
    pdb <- available.packages()
    gg <- tools::dependsOnPkgs("ggplot2", recursive = FALSE, installed = pdb)
    grep("^gg", gg, value = TRUE)
    ```
    

1. 重装R包，与 R 版本号保持一致

    ```{r,echo=TRUE,eval=FALSE}
    db <- installed.packages()
    db <- as.data.frame(db, stringsAsFactors = FALSE)
    pkgs <- db[db$Built < getRversion(), "Package"]
    install.packages(pkgs)
    ```

