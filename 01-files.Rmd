# 文件管理 {#files}

[给出 linux 下的对应命令]{.todo}

```{r,include=FALSE}
library(magrittr) # 提供管道命令 %>%
```

::: sidebar
- sys: Powerful replacements for base::system2 <https://github.com/jeroen/sys>
- fs: Provide cross platform file operations based on libuv <https://github.com/r-lib/fs>
:::

## 查看 {#list}

文件夹只包含文件，目录既包含文件又包含文件夹，`list.dirs` 列出目录或文件夹，`list.files` 列出文件或文件夹 

*  `list.dirs(path = ".", full.names = TRUE, recursive = TRUE)`
   +  path: 指定完整路径名，默认使用当前路径 `getwd()`
   +  full.names: TRUE 返回相对路径，FALSE 返回目录的名称
   +  recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

   ```{r,echo=TRUE}
   # list.dirs(path = '.',full.names = TRUE,recursive = TRUE)
   list.dirs(path = '.',full.names = TRUE,recursive = FALSE)
   list.dirs(path = '.',full.names = FALSE,recursive = FALSE)
   ```

*  `list.files(path = ".", pattern = NULL, all.files = FALSE, full.names = FALSE, recursive = FALSE,ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)`

   是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

   +  path: 指定完整路径名，默认使用当前路径 `getwd()`
   +  full.names: TRUE 返回相对路径，FALSE 返回目录的名称
   +  recursive: 是否递归的方式列出目录，如果是的话，目录下的子目录也会列出

* `file.show(..., header = rep("", nfiles), title = "R Information", delete.file = FALSE, pager = getOption("pager"),encoding = "")` 

   打开文件内容，`file.show` 会在R终端中新开一个窗口显示文件，如图\@ref(fig:show-file)所示

    ```{r,echo=TRUE}
    rinternals <- file.path(R.home("include"), "Rinternals.h")
    # file.show(rinternals)
    ```
    ```{r show-file,fig.cap = "file.show 打开文件"}
    knitr::include_graphics(path = 'figures/show-file.png')
    ```

* `file.info(..., extra_cols = TRUE)` 

   获取文件信息，此外 `file.mode(...)` 、 `file.mtime(...)` 和 `file.size(...)` 分别表示文件的读写权限，修改时间和文件大小。

    ```{r,echo=TRUE}
    file.info(rinternals)
    file.mode(rinternals)
    file.mtime(rinternals)
    file.size(rinternals)
    ```

* `file.access(names, mode = 0)`  

   文件是否可以被访问，第二个参数 mode 一共有四种取值 0，1，2，4，分别表示文件的存在性，可执行，可写和可读四种，返回值 0 表示成功，返回值 -1 表示失败。

    ```{r,echo=TRUE}
    file.access(rinternals,mode = 0)
    file.access(rinternals,mode = 1)
    file.access(rinternals,mode = 2)
    file.access(rinternals,mode = 4)
    ```

* `dir(path = ".", pattern = NULL, all.files = FALSE, full.names = FALSE, recursive = FALSE, ignore.case = FALSE, include.dirs = FALSE, no.. = FALSE)`
   
   查看目录，首先看看和目录操作有关的函数列表

    ```{r,echo=TRUE}
    apropos("^dir.")
    ```
    
   显而易见，`dir.create` 和 `dir.exists` 分别是创建目录和查看目录的存在性。`dirname` 和 `basename` 是一对函数用来操作文件路径。以当前目录`r getwd()`为例，`dirname(getwd())` 返回 `r dirname(getwd())` 而 `basename(getwd())` 返回 `r basename(getwd())`。对于文件路径而言，`dirname(rinternals)` 返回文件所在的目录`r dirname(rinternals)`， `basename(rinternals)` 返回文件名`r basename(rinternals)`。查看指定路径或目录下的文件，支持以模式匹配和递归的方式查找目录下的文件

    ```{r,echo=TRUE,out.lines=6}
    # 当前目录下的子目录和文件
    dir()
    # 查看指定目录的子目录和文件
    dir(path = "./")
    # 只列出以字母R开头的子目录和文件
    dir(path = "./", pattern = "^R")
    # 列出目录下所有目录和文件，包括隐藏文件
    dir(path = "./", all.files = TRUE)
    ```

## 操作 {#manipulation}

文件增删改查

```{r,echo=TRUE}
apropos("^file.")
```

```
file.create(..., showWarnings = TRUE)
file.exists(...)
file.remove(...)
file.rename(from, to)
file.append(file1, file2)
file.copy(from, to, overwrite = recursive, recursive = FALSE,
          copy.mode = TRUE, copy.date = FALSE)
file.symlink(from, to) creation of symbolic links (and their Windows analogues),
file.link(from, to)
Sys.junction(from, to)

Sys.readlink(paths) Read File Symbolic Links
```

`choose.files`  

下载文件

```{r,echo=TRUE}
apropos("^download.")
```

```{r,echo=TRUE}
# 查看当前目录的权限
file.info(".")
# 查看指定目录权限
file.info("./_book/")
# 在临时目录下递归创建一个目录
dir.create(paste0(tempdir(), "/_book/tmp"), recursive = TRUE)
```

## 压缩 {#compression}

`tar/untar` 与 `zip/unzip`

1. 将 `.csv` 文件压缩成 `.tar.bz2` 格式

   ```bash
   tar -cjf clientip.tar.bz2 clientip.csv
   ```

1. 当前目录下，将目录 `rstan/` 下的所有文件压缩为 `rstan.tar.gz` 文件

   ```bash
   tar -czf rstan.tar.gz ./rstan/*
   ```




tar 解压

```bash
tar -xzf R-3.5.1.tar.gz
```


tar

1. `-v` 解压过程中显示文件


## 路径 {#paths}

环境变量算是路径操作

Sys.getenv  获取环境变量
Sys.setenv  设置环境变量

操作文件路径

file.path Construct Path to File

basename(path) Manipulate File Paths
dirname(path)

path.expand(path) Expand File Paths

normalizePath() Express File Paths in Canonical Form
shortPathName(path)  Express File Paths in Short Form

Sys.glob  Wildcard Expansion on File Paths

```{r,echo=TRUE}
Sys.glob(file.path(R.home(), "library", "*", "R", "*.rdx")) %>% head(5)
```

## 查找 {#find}

查找文件、可执行文件的完整路径、R 包

Sys.which Find Full Paths to Executables

system.file  Find Names of R System Files
R.home
.libPaths()
find.package 
file.exist 

## 权限 {#permissions}

操作目录和文件的权限 Manipulation of Directories and File Permissions

dir.exists(paths)
dir.create(path, showWarnings = TRUE, recursive = FALSE, mode = "0777")
Sys.chmod(paths, mode = "0777", use_umask = TRUE)
Sys.umask(mode = NA)

## 区域 {#locale}

Query or Set Aspects of the Locale

Sys.getlocale(category = "LC_ALL")
Sys.setlocale(category = "LC_ALL", locale = "")
Sys.localeconv

Find Details of the Numerical and Monetary Representations in the Current Locale

## 进程 {#process}

聊聊什么是进程，线程

Sys.getpid Get the Process ID of the R Session

proc.time()          Running Time of R/ for the timings for the session.
system.time         for measuring elapsed/CPU time of expressions.
gc.time             Report Time Spent in Garbage Collection




## 调用 {#system}

system system2 系统命令 Invoke a System Command

## 时间 {#time}

时区 时间

Sys.timezone

Sys.time
Sys.Date

date

as.POSIX* Date-time Conversion Functions

Sys.setFileTime()

```{r,echo=TRUE}
# 获取时区信息
Sys.timezone()

format(Sys.time(), tz = 'America/Los_Angeles', usetz = TRUE)
format(Sys.time(), tz = 'Canada/Eastern', usetz = TRUE)
# 存放时区信息的数据库位置
file.path(R.home("share"), "zoneinfo")

strptime(Sys.time(), format ="%Y-%m-%d %H:%M:%S", tz = "Asia/Taipei")
```

## 搜索 {#search}

help.search
?regrex

## R 包 {#package}

```{r,echo=TRUE}
apropos('packages')
```

1. `.packages(T)` 已安装的 R 包

    ```{r,echo=TRUE}
    .packages(T) %>% length()
    ```
   
1. `available.packages` 查询可用的 R 包

    ```{r,echo=TRUE}
    available.packages()[,"Package"] %>% head()
    ```

1. `download.packages` 下载 R 包

    ```{r,echo=TRUE,eval=FALSE}
    download.packages("Rbooks", destdir = "~/", repos = "https://r-forge.r-project.org/")
    ```

1. `install.packages` 安装 R 包

    ```{r,echo=TRUE,eval=FALSE}
    install.packages("bookdown")
    ```

1. `installed.packages` 已安装的 R 包

    ```{r,echo=TRUE,eval=FALSE}
    installed.packages(fields = c("Package","Version")) %>% head()
    ```

1. `remove.packages` 卸载/删除/移除已安装的R包

    ```{r,echo=TRUE,eval=FALSE}
    remove.packages('bookdown')
    ```
 
1. `update.packages` 更新已安装的 R 包

    ```{r,echo=TRUE,eval=FALSE}
    update.packages(aask = FALSE)
    ```

1. `old.packages` 查看过时/可更新的 R 包

    ```{r,echo=TRUE}
    old.packages() %>% head()
    ```

1. `new.packages` 还没有安装的 R 包 

    ```{r,echo=TRUE}
    new.packages() %>% head()
    ```

1. `packageStatus` 查看已安装的 R 包状态，可更新、可下载等

    ```{r,echo=TRUE}
    packageStatus()
    ```
    
1. `packageDescription` 查询 R 包描述信息

    ```{r,echo=TRUE,out.lines=6}
    packageDescription('bookdown')
    ```

1. 查询 R 包的依赖关系

    ```{r,echo=TRUE,eval=require('bookdown')}
    # bookdown 依赖的 R 包
    tools::package_dependencies('bookdown', recursive = TRUE)
    # 依赖 bookdown 的 R 包
    tools::dependsOnPkgs('bookdown', recursive = TRUE)
    ```




