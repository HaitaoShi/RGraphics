\cleardoublepage 

# (APPENDIX) 附录 {#appendix .unnumbered}

# 安装 R {#install-r}

主要参考 R-admin

## 仓库安装 {#repo-install}

### Ubuntu

只考虑最新的 Ubuntu 18.04 因为本书写成的时候，该版本应该已经大规模使用了

* Ubuntu 14.04.5 安装最新版 R-3.5.x

  ```bash
  sudo apt-add-repository -y "deb https://mirrors.tuna.tsinghua.edu.cn/CRAN/bin/linux/ubuntu trusty-cran35/"
  sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
  sudo add-apt-repository -y "ppa:marutter/c2d4u3.5"
  sudo add-apt-repository -y "ppa:marutter/rrutter3.5"
  ```


* Ubuntu 16.04.5
* Ubuntu 18.04.1

默认版本
最新版本
之前版本

```bash
sudo apt-get install -y r-base r-base-core r-base-dev
```

### CentOS

同样适用于 Fedora

安装指导[^install-r]

[^install-r]: 在 CentOS 7 上打造 R 语言编程环境 

## 源码安装 {#source-install}

### Ubuntu


### CentOS

基于 CentOS 7 和 GCC 4.8.5，参考 R-admin 手册

* 下载源码包

  最新发布的稳定版
  
  ```bash
  curl -fLo ./R-latest.tar.gz https://mirrors.tuna.tsinghua.edu.cn/CRAN/src/base/R-latest.tar.gz
  ```
  ```
    % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                   Dload  Upload   Total   Spent    Left  Speed
   10 28.7M   10 3232k    0     0   107k      0  0:04:34  0:00:30  0:04:04  118k
  ```

* 安装依赖

  ```bash
  sudo yum groupinstall "Development Tools" 
  sudo yum install -y epel-release gcc gcc-objc gcc-objc++ deltarpm
  sudo yum install -y libcurl-devel openssl-devel libssh2-devel \
     libgit2-devel libxml2-devel tcl-devel tk-devel \
     readline-devel v8-314-devel libXmu libXmu-devel \
     mesa-libGLU mesa-libGLU-devel libicu-devel \
     libX11 libX11-devel libXt libXt-devel \
     pango pango-devel pcre pcre-devel pcre2 pcre2-devel \
     cairo cairo-devel zlib-devel bzip2-devel
  #   ImageMagick-c++-devel librsvg2-devel fftw-devel \
  #   netcdf-devel hdf5-devel armadillo-devel unixODBC-devel \
  ```

* 解压配置
  
  ```bash
  mkdir R-latest && tar -xzf ./R-latest.tar.gz -C ./R-latest && cd R-3.5.2
  
  ./configure --enable-R-shlib --enable-byte-compiled-packages \
    --enable-BLAS-shlib --enable-memory-profiling
  ```
  ```
  R is now configured for x86_64-pc-linux-gnu
  
    Source directory:          .
    Installation directory:    /usr/local
  
    C compiler:                gcc -std=gnu99  -g -O2
    Fortran 77 compiler:       gfortran  -g -O2
  
    Default C++ compiler:      g++   -g -O2
    C++98 compiler:            g++ -std=gnu++98 -g -O2
    C++11 compiler:            g++ -std=gnu++11 -g -O2
    C++14 compiler:
    C++17 compiler:
    Fortran 90/95 compiler:    gfortran -g -O2
    Obj-C compiler:            gcc -g -O2 -fobjc-exceptions
  
    Interfaces supported:      X11, tcltk
    External libraries:        readline, curl
    Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU
    Options enabled:           shared R library, shared BLAS, R profiling, memory profiling
  
    Capabilities skipped:
    Options not enabled:
  
    Recommended packages:      yes
  ```

* 编译安装

  ```bash
  make -j 2 all
  sudo make install
  ```

* BLAS 加持（可选）

  BLAS 对于加快矩阵计算至关重要，编译 R 带 [BLAS 支持][BLAS]，添加 OpenBLAS 支持 `--with-blas="-lopenblas"` 或 ATLAS 支持 `--with-blas="-L/usr/lib64/atlas -lsatlas"` 

  ```bash
  sudo yum install -y openblas openblas-threads openblas-openmp 
  
  ./configure --enable-R-shlib --enable-byte-compiled-packages \
    --enable-BLAS-shlib --enable-memory-profiling \
    --with-blas="-lopenblas"
  ```
  ```
  R is now configured for x86_64-pc-linux-gnu

  Source directory:          .
  Installation directory:    /usr/local

  C compiler:                gcc -std=gnu99  -g -O2
  Fortran 77 compiler:       gfortran  -g -O2

  Default C++ compiler:      g++   -g -O2
  C++98 compiler:            g++ -std=gnu++98 -g -O2
  C++11 compiler:            g++ -std=gnu++11 -g -O2
  C++14 compiler:
  C++17 compiler:
  Fortran 90/95 compiler:    gfortran -g -O2
  Obj-C compiler:            gcc -g -O2 -fobjc-exceptions

  Interfaces supported:      X11, tcltk
  External libraries:        readline, BLAS(OpenBLAS), curl
  Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU
  Options enabled:           shared R library, shared BLAS, R profiling, memory profiling

  Capabilities skipped:
  Options not enabled:

  Recommended packages:      yes
  ```

  配置成功的标志，如 OpenBLAS
  
  ```
  checking for dgemm_ in -lopenblas... yes
  checking whether double complex BLAS can be used... yes
  checking whether the BLAS is complete... yes
  ```

  ATLAS 加持

  ```  
  sudo yum install -y atlas
  ./configure --enable-R-shlib --enable-byte-compiled-packages \
    --enable-BLAS-shlib --enable-memory-profiling \
    --with-blas="-L/usr/lib64/atlas -lsatlas"
  ```
  ```
  R is now configured for x86_64-pc-linux-gnu

  Source directory:          .
  Installation directory:    /usr/local

  C compiler:                gcc -std=gnu99  -g -O2
  Fortran 77 compiler:       gfortran  -g -O2

  Default C++ compiler:      g++   -g -O2
  C++98 compiler:            g++ -std=gnu++98 -g -O2
  C++11 compiler:            g++ -std=gnu++11 -g -O2
  C++14 compiler:
  C++17 compiler:
  Fortran 90/95 compiler:    gfortran -g -O2
  Obj-C compiler:            gcc -g -O2 -fobjc-exceptions

  Interfaces supported:      X11, tcltk
  External libraries:        readline, BLAS(generic), curl
  Additional capabilities:   PNG, JPEG, TIFF, NLS, cairo, ICU
  Options enabled:           shared R library, shared BLAS, R profiling, memory profiling

  Capabilities skipped:
  Options not enabled:

  Recommended packages:      yes
  ```
  
  ATLAS 配置成功

  ```
  checking for dgemm_ in -L/usr/lib64/atlas -lsatlas... yes
  checking whether double complex BLAS can be used... yes
  checking whether the BLAS is complete... yes
  ```

后续步骤同上

[BLAS]: https://cran.r-project.org/doc/manuals/r-release/R-admin.html#BLAS

## 忍者安装 {#ninja-install}

从源码自定义安装：加速 Intel MKL 和 大文件支持

### Ubuntu

### CentOS


## 安装 R 包 {#install-package}

1. [devtools](https://github.com/r-lib/devtools) 是开发 R 包的常用工具，同时具有很重的依赖，请看

   ```{r,eval=require('devtools'),echo=TRUE}
   tools::package_dependencies('devtools',recursive=T)
   ```

   其中，依赖关系见表 \@ref(tab:devtools-sys-dep)
   
   Table: (\#tab:devtools-sys-dep) devtools 的系统依赖  

   |               |     [curl]     |      [git2r]   |    [openssl]  
   |:------------- | :------------- | :------------- | :------------- 
   |  Ubuntu       | libcurl-dev[^curl-dev] |  libgit2-dev   |   libssl-dev  
   |  CentOS       | libcurl-devel  |  libgit2-devel |  openssl-devel

1. [sf](https://github.com/r-spatial/sf) 是处理空间数据的常用工具

   ```{r,eval=require('sf'),echo=TRUE}
   tools::package_dependencies('sf',recursive=T)
   ```
   
   其主要的系统依赖分别是
   
   ```bash
   sudo add-apt-repository -y ppa:ubuntugis/ubuntugis-unstable
   sudo apt-get update
   sudo apt-get install -y libudunits2-dev libgdal-dev libgeos-dev libproj-dev 
   ```
   
   这样也同时解决了 [udunits2]、 [rgdal] 和 [rgeos] 等 3个R包的系统依赖，其中 udunits2 使用如下命令安装
   
   ```r
   install.packages("udunits2",configure.args='--with-udunits2-include=/usr/include/udunits2')
   ```
   
1. 图形设备支持 cairo png jpeg tiff

   ```bash
   sudo apt-get install -y libcairo2-dev libjpeg-dev libpng-dev libtiff-dev 
   ```

1. 图像处理 [imager] 和 [magick]

   ```bash
   sudo yum install fftw-devel # CentOS
   sudo apt-get install libfftw3-dev # Ubuntu
   ```
   
   在 Ubuntu 系统上安装最新的 libmagick++-dev 库
   
   ```bash
   sudo add-apt-repository -y ppa:opencpu/imagemagick
   sudo apt-get update
   sudo apt-get install -y libmagick++-dev 
   ```
   
   在 CentOS 系统上
   
   ```bash
   sudo yum install -y ImageMagick-c++-devel
   ```
   
   然后安装 R 包 `install.packages(c('imager','magick'))`

1. [rgl] 是绘制真三维图形的重量级 R 包

   ```bash
   sudo apt-get install libcgal-dev libglu1-mesa-dev libglu1-mesa-dev libx11-dev # Ubuntu
   sudo yum install mesa-libGLU mesa-libGLU-devel # CentOS
   ```
   
   然后安装 R 包
   
   ```r
   install.packages('rgl')
   ```
   
   在 Ubuntu 系统上还可以这样安装
   
   ```bash
   sudo add-apt-repository ppa:marutter/rrutter3.5
   sudo apt-get update
   sudo apt-get install r-cran-rgl
   ```

1. [rJava] 是 Java 语言和 R 语言之间实现通信交流的桥梁

   ```bash
   sudo apt-get install -y default-jdk
   sudo R CMD javareconf
   ```
   ```
   Java interpreter : /usr/bin/java
   Java version     : 1.8.0_171
   Java home path   : /usr/lib/jvm/java-8-openjdk-amd64/jre
   Java compiler    : /usr/bin/javac
   Java headers gen.: /usr/bin/javah
   Java archive tool: /usr/bin/jar
  
   trying to compile and link a JNI program
   detected JNI cpp flags    : -I$(JAVA_HOME)/../include -I $(JAVA_HOME)/../include/linux
   detected JNI linker flags : -L$(JAVA_HOME)/lib/amd64/ser ver -ljvm
   gcc -I"/usr/local/lib/R/include" -DNDEBUG -I/usr/lib/jvm /java-8-openjdk-amd64/jre/../include -I/usr/lib/jvm/java -8-openjdk-amd64/jre/../include/linux  -I/usr/local/incl ude   -fpic  -g -O2  -c conftest.c -o conftest.o
   gcc -shared -L/usr/local/lib -o conftest.so conftest.o - L/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/amd64/server  -ljvm

   JAVA_HOME        : /usr/lib/jvm/java-8-openjdk-amd64/jre
   Java library path: $(JAVA_HOME)/lib/amd64/server
   JNI cpp flags    : -I$(JAVA_HOME)/../include -I$(JAVA_HO ME)/../include/linux
   JNI linker flags : -L$(JAVA_HOME)/lib/amd64/server -ljvm
   Updating Java configuration in /usr/local/lib/R
   Done.
   ```
   
   然后安装 rJava 包
   
   ```r
   install.packages("rJava")
   ```

[^curl-dev]: libcurl-dev 是一个虚包 virtual package，由 libcurl4-openssl-dev 或 libcurl4-nss-dev 或 libcurl4-gnutls-dev 实际提供，选择其中一个安装即可。
[curl]: https://github.com/jeroen/curl
[git2r]: https://github.com/ropensci/git2r
[openssl]: https://github.com/jeroen/openssl
[udunits2]: https://github.com/pacificclimate/Rudunits2
[rgdal]: https://r-forge.r-project.org/projects/rgdal/
[rgeos]: https://r-forge.r-project.org/projects/rgeos/
[rgl]: https://r-forge.r-project.org/projects/rgl/
[rJava]: https://github.com/s-u/rJava
[imager]: https://github.com/dahtah/imager
[magick]: https://github.com/ropensci/magick
