# 数据清洁工 {#data-cleaner}

## `grep` 和 `grepl` {#grep-grepl}

- `ignore.case`: `TRUE` 表示忽略大小写，`FALSE` 表示匹配的时候区分大小写

`grep` 返回匹配到的字符串向量x的元素的下标，如果 `value=TRUE` 则返回下标对应的值

```{r,echo=TRUE}
grep(x = c("apple", "banana"), pattern = "a")
grep(x = c("apple", "banana"), pattern = "b")
grep(x = c("apple", "banana"), pattern = "a", value = TRUE)
grep(x = c("apple", "banana"), pattern = "b", value = TRUE)
```

`grepl` 返回一个逻辑向量，字符串向量x中的每个元素是否匹配到，匹配到返回 `TRUE`，没有匹配到返回 `FALSE`

```{r,echo=TRUE}
grepl(x = c("apple", "banana"), pattern = "a")
grepl(x = c("apple", "banana"), pattern = "b")
```

- `fixed=TRUE` 表示启用原生字符raw strings匹配，或者 literal regular expression 字面正则表达式，默认情况下 `fixed=FALSE`

::: sidebar
R 是用字符串来表示正则表达式的，但是正则表达式不是字符串，字符串的构造类似算术表达式
::: 

在 R 里面分别表示 `a\\b` 和 `a\b`

```{r,echo=TRUE}
writeLines(c("a\\\\b", "a\\b"))
```

下面在 R 里面分别匹配字符串 `a\\b` 和 `a\b` 中的 `\\` 和 `\`

```{r,echo=TRUE}
# 匹配字符串中的一个反斜杠
grep(x = c("a\\\\b", "a\\b"), pattern = "\\", value = TRUE, fixed = TRUE)
grep(x = c("a\\\\b", "a\\b"), pattern = "\\\\", value = TRUE, fixed = FALSE)

# 匹配字符串中的两个反斜杠
grep(x = c("a\\\\b", "a\\b"), pattern = "\\\\", value = TRUE, fixed = TRUE)
grep(x = c("a\\\\b", "a\\b"), pattern = "\\\\\\\\", value = TRUE, fixed = FALSE)

# 匹配字符串中的两个反斜杠 \\
grepl(x = "a\\\\b", pattern = "\\\\\\\\", fixed = FALSE)
grepl(x = "a\\\\b", pattern = "\\\\\\\\", fixed = TRUE)
grepl(x = "a\\\\b", pattern = "\\\\", fixed = TRUE)
```

此外，还有一个函数 `grepRaw` 用于匹配 Raw Vectors 

## `sub` 与 `gsub` {#sub-gsub}


```{r,echo=TRUE}
sub(" .*", "", extSoftVersion()["PCRE"])
```

## `regexpr` 与 `gregexpr` {#regexpr-gregexpr}

函数 `regexpr` 和 `gregexpr` 支持 named capture. If groups are named, e.g., `(?<first>[A-Z][a-z]+)` then the positions of the matches are also returned by name. 函数 `sub` 不支持 Named backreferences

```r
regexpr(pattern, text, ignore.case = FALSE, perl = FALSE,
        fixed = FALSE, useBytes = FALSE)
```

```{r,echo=TRUE}
data(acq, package = 'tm')
writeLines(acq$content[[1]]$content)
```

```{r,echo=TRUE}
regexpr(pattern = "<.*>", text = acq$content[[1]]$content)
```

```{r,echo=TRUE}
txt <- c("The", "licenses", "for", "most", "software", "are",
  "designed", "to", "take", "away", "your", "freedom",
  "to", "share", "and", "change", "it.",
  "", "By", "contrast,", "the", "GNU", "General", "Public", "License",
  "is", "intended", "to", "guarantee", "your", "freedom", "to",
  "share", "and", "change", "free", "software", "--",
  "to", "make", "sure", "the", "software", "is",
  "free", "for", "all", "its", "users")
# gregexpr("en", txt)
regexpr("en", txt)
```

## regmatches

提取正则表达式匹配到的结果

`regmatches` for extracting matched substrings based on the results of `regexpr`, `gregexpr` and `regexec`.

## stringi 和 stringr {#stringi-stringr}

[Handling Strings with R](https://www.gastonsanchez.com/r4strings/) 和 [Text Mining with R A Tidy Approach](https://www.tidytextmining.com/) 字符串入门介绍 [R for Data Science](https://r4ds.had.co.nz/strings.html)

[stringr](https://stringr.tidyverse.org/) 基于 [stringi](https://github.com/gagolews/stringi) 包字符串处理包，[re2r](https://github.com/qinwf/re2r/) 包基于 Google 开发的 C++ 库 [re2](https://github.com/google/re2)，Google 编程之夏项目提供了一份，[正则表达式性能综述](https://github.com/rstats-gsoc/gsoc2016/wiki/re2-regular-expressions)

Pattern Matching and Replacement 模式匹配和替换

正则表达式 is ervrywhere，is 高级/hacker's skill 技能

- [正则表达式速查表 -- Python3](https://www.dataquest.io/blog/large_files/python-regular-expressions-cheat-sheet.pdf)
- [Online regex tester and debugger](https://regex101.com/)
- [Regular expression operations](https://docs.python.org/3/library/re.html)
- [Handling Strings with R](http://www.gastonsanchez.com/r4strings/) 字符串处理

## RCurl 和 XML {#rcurl-xml}

用 R 语言写爬虫 解析网页

web 服务都会用到正则吧

curl 和 xml2 以及 rvest

libcurl 库的版本

```{r,echo=TRUE}
libcurlVersion()
```

## 扩展阅读 {#more-readings}

[How did Axios rectangle Trump's PDF schedule? A try with R](https://masalmon.eu/2019/02/11/trump-schedule/) 使用 pdftools 和 magick 处理表格，这两个R包分别依赖 Poppler C++ 和 ImageMagick++

如何在 Ubuntu 18.04 上安装 `poppler >= 0.73` [^install-poppler]

[^install-poppler]: https://askubuntu.com/questions/1112856

[Manipulating strings with the {stringr} package](https://www.brodrigues.co/blog/2019-02-10-stringr_package/)

PDF 表格抽取工具 [tabulizer](https://github.com/ropensci/tabulizer)

在 Ubuntu 上安装 pdftools 和 magick

```bash
sudo apt-get install libpoppler-cpp-dev libmagick++-dev
```

```{r,echo=TRUE,eval=FALSE}
install.packages(c("pdftools", "magick"))
```
