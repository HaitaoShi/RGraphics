# 软件工具 {#software-tools}

## 编辑器 {#editor}

1. Atom 编辑器^[<https://atom.io/>]

  ```bash
  sudo add-apt-repository ppa:webupd8team/atom
  sudo apt-get update
  sudo apt-get install atom
  ```

1. Code 编辑器微软出品

  > https://code.visualstudio.com/

1. Notepad++ 开源的 Windows 平台上的编辑器
  
  > https://notepad-plus-plus.org/

1. VI & VIM 开源的跨平台编辑器

Atom 和 Code 有商业公司支持的开源免费的跨平台的编辑器

VI/VIM 和 Emacs 是跨平台的编辑器

## 版本控制 {#version-control}

只考虑 Ubuntu 18.04 环境

三剑客 Git & Github & Gitlab

Ubuntu 16.04.5 默认安装的 Git 版本是 2.7.4，下面安装最新版本Git和配置自己的GitHub账户

1. 安装[^install-git]

   ```bash
   sudo add-apt-repository -y ppa:git-core/ppa
   sudo apt update && sudo apt install git
   ```

1. 配置

   ```bash
   git config --global user.name "Your Name Comes Here"
   git config --global user.email you@yourdomain.example.com
   ```

Git 使用的数据库

[^install-git]: 根据官网安装指导 https://git-scm.com/download/linux，在 Ubuntu 14.04.5 和 Ubuntu 16.04.5 安装最新版 GIT 

## 动态文档 {#dynamic-documents}

三剑客 Markdown & Pandoc's Markdown & R Markdown

Pandoc 是一个万能文档转化器

1. 安装 calibre

   ```bash
   sudo -v && wget -nv -O- https://download.calibre-ebook.com/linux-installer.sh | sudo sh /dev/stdin
   ```

   calibre 可以将 epub 格式电子书文档转化为 mobi 格式，bookdown 已经给这个工具穿上了一件马甲，所以用户只需调用 `bookdown::calibre` 函数即可。

1. 安装 pandoc

   ```bash
   sudo apt-get install gdebi-core
   wget https://github.com/jgm/pandoc/releases/download/2.5/pandoc-2.5-1-amd64.deb
   sudo chmod +x pandoc-2.5-1-amd64.deb
   sudo gdebi pandoc-2.5-1-amd64.deb
   ```
   
   rmarkdown 包裹了 Pandoc 工具，所以使用 `rmarkdown::render` 函数，即可将 R Markdown 文档转化为 HTML、LaTeX 和 Markdown 等格式。

### Markdown

Markdown 基础语法见 RStudio IDE 自带的手册 Markdown Quick Reference，这里主要介绍一下Markdown高级语法，特别是 Pandoc's Markdown^[Pandoc 提供了很多对 Markdown 的扩展支持]表格、图片和公式的使用

- 表格

  插入表格很简单的，如表 \@ref(tab:insert-tab) 所示，还带脚注哦

   Table: (\#tab:insert-tab) A table caption^[With a footnote]
   
   | First Header | Second Header |
   | :----------- | :------------ |
   | Content Cell | Content Cell  |
   | Content Cell | Content Cell  |

- 图片

   插入图片也很简单的，所示，图、表的标题很长或者需要插入脚注，可以使用[文本引用][text-references]

   ```{r knitr-footnote, fig.cap='(ref:footnote)', out.width="45%", echo=FALSE}
   knitr::include_graphics(path = "figures/mai.png")
   ```

(ref:footnote) caption 插入 footnote 但是 ebooks 不支持这样插入脚注[^longnote]

[^longnote]: Here's one with multiple blocks.

[text-references]: https://bookdown.org/yihui/bookdown/markdown-extensions-by-bookdown.html#text-references

- 公式

   行内公式一对美元符号 $\alpha$ 或者 \(\alpha+\beta\)，行间公式 $$\alpha$$ 或者 \[\alpha + \beta\] 对公式编号，如公式 \@ref(eq:likelihood)

   \begin{equation}
   L(\beta,\boldsymbol{\theta}) = f(y;\beta,\boldsymbol{\theta}) = \int_{\mathbb{R}^{n}}N(t;D\beta,\Sigma(\boldsymbol{\theta}))f(y|t)dt (\#eq:likelihood)
   \end{equation}

   多行公式分别编号，如公式\@ref(eq:BL-SGLMM) 和公式\@ref(eq:Poss-SGLMM) 

   \begin{align}
   \log\{\frac{p_i}{1-p_i}\} & = T_{i} = d(x_i)'\beta + S(x_i) + Z_i (\#eq:BL-SGLMM)\\
   \log(\lambda_i)           & = T_{i} = d(x_i)'\beta + S(x_i) + Z_i (\#eq:Poss-SGLMM)
   \end{align}

   多行公式中对某一（些）行编号，如公式 \@ref(eq:align) 和 公式 \@ref(eq:Poss-SGLMM2)

   \begin{align} 
   g(X_{n}) &= g(\theta)+g'({\tilde{\theta}})(X_{n}-\theta) \\
   \sqrt{n}[g(X_{n})-g(\theta)] &= g'\left({\tilde{\theta}}\right) 
     \sqrt{n}[X_{n}-\theta ] (\#eq:align) \\
   \log(\lambda_i)  & = T_{i} = d(x_i)'\beta + S(x_i) + Z_i (\#eq:Poss-SGLMM2)  
   \end{align} 

   多行公式共用一个编号，如公式 \@ref(eq:likelihood2)

   \begin{equation}
   \begin{aligned}
   L(\beta,\boldsymbol{\theta})
   & = \int_{\mathbb{R}^{n}} \frac{N(t;D\beta,\Sigma(\boldsymbol{\theta}))f(y|t)}{N(t;D\beta_{0},\Sigma(\boldsymbol{\theta}_{0}))f(y|t)}f(y,t)dt\\
   & \varpropto \int_{\mathbb{R}^{n}} \frac{N(t;D\beta,\Sigma(\boldsymbol{\theta}))}{N(t;D\beta_{0},\Sigma(\boldsymbol{\theta}_{0}))}f(t|y)dt \\
   &= E_{T|y}\left[\frac{N(t;D\beta,\Sigma(\boldsymbol{\theta}))}{N(t;D\beta_{0},\Sigma(\boldsymbol{\theta}_{0}))}\right] 
   \end{aligned}
   (\#eq:likelihood2)
   \end{equation}

   推荐在 `equation` 公式中，使用 `split` 环境，意思是一个公式很长，需要拆成多行，如公式\@ref(eq:var-beta)

   \begin{equation} 
   \begin{split}
   \mathrm{Var}(\hat{\beta}) & =\mathrm{Var}((X'X)^{-1}X'y)\\
    & =(X'X)^{-1}X'\mathrm{Var}(y)((X'X)^{-1}X')'\\
    & =(X'X)^{-1}X'\mathrm{Var}(y)X(X'X)^{-1}\\
    & =(X'X)^{-1}X'\sigma^{2}IX(X'X)^{-1}\\
    & =(X'X)^{-1}\sigma^{2}
   \end{split}
   (\#eq:var-beta)
   \end{equation} 

   注意，`\mathbf` 只对字母 $a,b,c,A,B,C$ 加粗，mathjax 不支持公式中使用 `\bm` 对 $\theta,\alpha,\beta,\ldots,\gamma$ 加粗，应该使用 `\boldsymbol`

### bookdown

The **bookdown** package can be installed from CRAN or Github:

`par()` 图形版面设置，如图\@ref(fig:par) 所示


```{r par,fig.cap="图形参数设置",fig.subcap=c("单图环境","多图环境"),out.width="33%",echo=FALSE, fig.link='https://github.com/rstudio/rmarkdown'}
knitr::include_graphics(path = c("figures/mai.png","figures/mai.png"))
```


```{r eval=FALSE}
install.packages("bookdown")
# or the development version
# devtools::install_github("rstudio/bookdown")
```

Remember each Rmd file contains one and only one chapter, and a chapter is defined by the first-level heading `#`.

通过 <https://bookdown.org/> 发布书籍

### TinyTeX {#tinytex}

[TinyTeX 发行版和LaTeX 包管理器 tlmgr].{todo}

如何编译获取电子版，拉取镜像，安装缺失的依赖

```bash
docker run --name book -d -p 8282:8787 -e ROOT=TRUE \
 -e USER=rstudio -e PASSWORD=cloud rocker/geospatial
```

主机端口 8282 分配给容器内 RStudio Server 服务，进入容器后，为方便下载LaTeX宏包和R包起见，建议选择就近的站点

```bash
tlmgr option repository https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/texlive/tlnet
echo 'options(repos = c(CRAN = "https://mirrors.tuna.tsinghua.edu.cn/CRAN"))' > ~/.Rprofile.site
```

安装常用的软件包依赖

```bash
sudo apt-get install imagemagick optipng ghostscript graphviz \
   libgit2-dev libssh2-1-dev libglu1-mesa-dev \
   libfreetype6-dev libxpm-dev libx11-dev libxaw7-dev \
   tk-dev tcl-dev graphviz-dev phantomjs \
   libosmesa6 libosmesa6-dev freeglut3 freeglut3-dev 
```

imagemagick 用于图片格式转化，optipng 用于 png 格式的图片压缩优化，ghostscript 字体处理

然后安装常用的 LaTeX 宏包

```{r,eval=FALSE,echo=TRUE}
tinytex::tlmgr_install(pkgs = c(
  "ctex", "ms", "xecjk", "ulem", "environ", 
  "trimspaces", "zhnumber", "fandol", "filehook", 
  "xcolor", "colortbl", "jknapltx", "lm-math", 
  "rsfs", "pdfcrop", "subfig"
))
```

我用了两个 R 包编译这本书，分别是 **knitr**\index{knitr}  和 **bookdown**\index{bookdown}。


## 开发环境 {#ide}

### RStudio IDE {#rstudio-ide}

RStudio 开源桌面版 & RStudio Server 开源服务器版 & RStudio Shiny Server 开源服务器版

1. 下载 RStudio IDE
 
   我们从 RStudio 官网[下载][rstudio-download]开源桌面或服务器版本，服务器版本的使用介绍见[文档](http://docs.rstudio.com/ide/server-pro/)，最常见的就是设置端口

   ```bash
   wget https://download2.rstudio.org/rstudio-server-1.1.456-amd64.deb
   sudo gdebi rstudio-server-1.1.456-amd64.deb
   ```

1. 设置端口
   
   在文件 `/etc/rstudio/rserver.conf` 下，设置

   ```
   www-port=8181
   ```

   注意：修改 `rserver.conf` 文件后需要重启才会生效
   
   ```bash
   sudo rstudio-server stop
   sudo rstudio-server start
   ```

   接着获取机器的 IP 地址，如 192.168.141.3

   ```bash
   ip addr
   ```
   ```
   1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
   2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
       link/ether 08:00:27:59:c0:fb brd ff:ff:ff:ff:ff:ff
       inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic enp0s3
          valid_lft 83652sec preferred_lft 83652sec
       inet6 fe80::a00:27ff:fe59:c0fb/64 scope link
          valid_lft forever preferred_lft forever
   3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
       link/ether 08:00:27:09:33:0d brd ff:ff:ff:ff:ff:ff
       inet 192.168.141.3/24 brd 192.168.141.255 scope global dynamic enp0s8
          valid_lft 547sec preferred_lft 547sec
       inet6 fe80::a00:27ff:fe09:330d/64 scope link
          valid_lft forever preferred_lft forever
   ```

   然后，就可以从本地浏览器登陆 RStudio 服务器版本，如 <http://192.168.141.3:8181/>


[rstudio-download]: https://www.rstudio.com/products/rstudio/download/


### Eclipse + StatET {#eclipse-plus-statet}

Eclipse 配合 StatET 插件^[<http://www.walware.de/goto/statet>]提供R语言的集成开发环境

### Emacs + ESS {#emacs-plus-ess}

Emacs 配合 ESS 插件^[<https://ess.r-project.org/>] 


### Nvim-R {#vim-plus-r}

Nvim-R 是一个基于 Vim 的集成开发环境^[<https://github.com/jalvesaq/Nvim-R>]

## 容器 {#container}

Docker & 容器管理工具 Docker Swarm

### Docker

Docker & Docker Machine & Docker Swarm

1. 容器与镜像的操作

   ```bash
   docker --version
   # Docker version 18.03.0-ce, build 0520e24302
   ```

   查看容器  
   
   ```bash
   docker ps -a
   ```

   删除容器 `docker rm 容器 ID`，删除前要确认已经停止该容器的运行
   
   ```bash
   docker rm 6f932357e6ce
   ```

   查看镜像 
   
   ```bash
   docker images
   ```

   删除镜像 
   
   `docker rmi 镜像 ID`
   
   ```bash
   docker rmi 811281c54b23
   ```

1. 拉取镜像

   ```bash
   docker pull rocker/verse:latest
   ```

1. 运行容器

   ```bash
   docker run --name verse -d -p 8282:8080 -e ROOT=TRUE \
      -e USER=rstudio -e PASSWORD=cloud rocker/verse
   ```
   
   将主机端口 8282 映射给虚拟机/容器的 8080 端口，RStudio Server 默认使用的端口是 8787，因此改为 8080 需要修改 `/etc/rstudio/rserver.conf` 文件，添加
   
   ```
   www-port=8080
   ```
   
   然后重启 RStudio Server，之后可以在浏览器中登陆[^rstudio-server-pro]，登陆网址为 <http://ip-addr:8080>，其中 `ip-addr` 可在容器中运行如下一行命令获得
   
   ```bash
   ip addr
   ```
   
[^rstudio-server-pro]: 参考 http://docs.rstudio.com/ide/server-pro/access-and-security.html

### Docker Machine

开源贡献站点 https://github.com/docker/machine

基本命令

* 查看 docker machine 版本信息

   ```{r,engine="bash",eval=FALSE,echo=TRUE}
   docker-machine --version
   # docker-machine.exe version 0.14.0, build 89b8332
   ```

* 列出创建的虚拟机

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   # 启动前
   docker-machine ls
   # NAME      ACTIVE   DRIVER       STATE     URL   SWARM   DOCKER    ERRORS
   # default   -        virtualbox   Stopped                 Unknown
   # 启动后
   docker-machine ls
   # NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS
   # default   *        virtualbox   Running   tcp://192.168.99.100:2376           v18.03.0-ce
   ```

* 查看虚拟机 default 的 ip

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker-machine ip default
   # 192.168.99.100
   ```

* 启动虚拟机

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker-machine start default
   # Starting "default"...
   # (default) Check network to re-create if needed...
   # (default) Windows might ask for the permission to configure a dhcp server. Sometimes, such confirmation window is minimized in the taskbar.
   # (default) Waiting for an IP...
   # Machine "default" was started.
   # Waiting for SSH to be available...
   # Detecting the provisioner...
   # Started machines may have new IP addresses. You may need to re-run the `docker-machine env` command.
   ```

* 进入 Docker 环境

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker-machine ssh default
   ```
   ```
                           ##         .
                     ## ## ##        ==
                  ## ## ## ## ##    ===
              /"""""""""""""""""\___/ ===
         ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
              \______ o           __/
                \    \         __/
                 \____\_______/
    _                 _   ____     _            _
   | |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __
   | '_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ '__|
   | |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   <  __/ |
   |_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|
   Boot2Docker version 18.03.0-ce, build HEAD : 404ee40 - Thu Mar 22 17:12:23 UTC 2018
   Docker version 18.03.0-ce, build 0520e24
   ```

* 查看容器

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker ps -a
   # CONTAINER ID        IMAGE               COMMAND             CREATED            STATUS                   PORTS               NAMES
   # 69e6929d269e        rocker/verse        "/init"             3 weeks ago        Exited (0) 10 days ago                       verse
   ```

* 启动/停止容器

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker start verse
   # verse
   docker stop verse
   # verse
   ```

* 查看虚拟机 default 的环境

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker-machine env default
   # export DOCKER_TLS_VERIFY="1"
   # export DOCKER_HOST="tcp://192.168.99.100:2376"
   # export DOCKER_CERT_PATH="D:\Docker\machines\default"
   # export DOCKER_MACHINE_NAME="default"
   # export COMPOSE_CONVERT_WINDOWS_PATHS="true"
   # # Run this command to configure your shell:
   # # eval $("C:\Program Files\Docker Toolbox\docker-machine.exe" env default)
   ```

* 关闭虚拟机 default

   ```{r, engine = "bash",eval=FALSE,echo=TRUE}
   docker-machine stop default
   # Stopping "default"...
   # Machine "default" was stopped.
   ```


帮助文档 https://docs.docker.com/machine/get-started



### Docker Swarm

### Kubernetes (k8s)

## 数据库 {#database}

## 常用工具 {#other-tools}

### Imagemagick


```bash
convert -quality 100 -density 300x300 filename.pdf filename.png
```

### optipng


```bash
optipng -o5 filename.png
```

### Ghostscript

Windows 下 GS 默认搜索路径不对，需要手动指定 Linux 平台下不需要关心 GS 的安装路径问题，特别地，需要指定字体搜索路径

```{r,eval=FALSE,echo=TRUE}
Sys.setenv(R_GSCMD = "C:/Program Files/gs/gs9.26/bin/gswin64c.exe")
embedFonts(
  file = "cm.pdf", outfile = "cm-embed.pdf",
  fontpaths = system.file("fonts", package = "fontcm")
)
embedFonts(file = "cm.pdf", outfile = "cm-embed.pdf") 
```
